<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="æ ‡ç­¾: WebSocket, delfino">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>æ ‡ç­¾: WebSocket | delfino</title>
    <link rel="icon" type="image/png" href="/blog/favicon.png">

    <link rel="stylesheet" type="text/css" href="/blog/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/blog/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/blog/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/blog/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/blog/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/my.css">

    <script src="/blog/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.0.0"><link rel="stylesheet" href="/blog/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/blog/" class="waves-effect waves-light">
                    
                    <img src="/blog/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">delfino</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/blog/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>é¦–é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/blog/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/blog/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/blog/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>å½’æ¡£</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/blog/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>å…³äº</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/blog/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>ç•™è¨€æ¿</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/blog/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">delfino</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/blog/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			é¦–é¡µ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/blog/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			æ ‡ç­¾
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/blog/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			åˆ†ç±»
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/blog/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			å½’æ¡£
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/blog/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			å…³äº
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/blog/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			ç•™è¨€æ¿
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/simple-delfino/blog" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #F062A7;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/simple-delfino/blog" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/blog/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">ä½ ä¸çŸ¥é“çš„ WebSocket</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/blog/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/blog/tags/WebSocket/">
                                <span class="chip bg-color">WebSocket</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/blog/categories/node/" class="post-category">
                                node
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2020-07-28
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>æ›´æ–°æ—¥æœŸ:&nbsp;&nbsp;
                    2020-08-03
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>æ–‡ç« å­—æ•°:&nbsp;&nbsp;
                    11.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>é˜…è¯»æ—¶é•¿:&nbsp;&nbsp;
                    46 åˆ†
                </div>
                

                <div class="info-break-policy">
                    
                    <i class="fa fa-pencil"></i> ä½œè€…: delfino
                    
                </div>
                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>é˜…è¯»æ¬¡æ•°:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>æœ¬æ–‡é˜¿å®å“¥å°†ä»å¤šä¸ªæ–¹é¢å…¥æ‰‹ï¼Œå…¨æ–¹ä½å¸¦ä½ ä¸€èµ·æ¢ç´¢ WebSocket æŠ€æœ¯ã€‚é˜…è¯»å®Œæœ¬æ–‡ï¼Œä½ å°†äº†è§£ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>äº†è§£ WebSocket çš„è¯ç”ŸèƒŒæ™¯ã€WebSocket æ˜¯ä»€ä¹ˆåŠå®ƒçš„ä¼˜ç‚¹ï¼›</li>
<li>äº†è§£ WebSocket å«æœ‰å“ªäº› API åŠå¦‚ä½•ä½¿ç”¨ WebSocket API å‘é€æ™®é€šæ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®ï¼›</li>
<li>äº†è§£ WebSocket çš„æ¡æ‰‹åè®®å’Œæ•°æ®å¸§æ ¼å¼ã€æ©ç ç®—æ³•ç­‰ç›¸å…³çŸ¥è¯†ï¼›</li>
<li>äº†è§£å¦‚ä½•å®ç°ä¸€ä¸ªæ”¯æŒå‘é€æ™®é€šæ–‡æœ¬çš„ WebSocket æœåŠ¡å™¨ã€‚</li>
</ul>
<p>åœ¨æœ€åçš„ <strong>é˜¿å®å“¥æœ‰è¯è¯´</strong> ç¯èŠ‚ï¼Œé˜¿å®å“¥å°†ä»‹ç» WebSocket ä¸ HTTP ä¹‹é—´çš„å…³ç³»ã€WebSocket ä¸é•¿è½®è¯¢æœ‰ä»€ä¹ˆåŒºåˆ«ã€ä»€ä¹ˆæ˜¯ WebSocket å¿ƒè·³åŠ Socket æ˜¯ä»€ä¹ˆç­‰å†…å®¹ã€‚</p>
<p>æ¨èé˜…è¯»ï¼ˆæ„Ÿè°¢æ˜å‹çš„é¼“åŠ±ä¸æ”¯æŒğŸŒ¹ğŸŒ¹ğŸŒ¹ï¼‰ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/6844904198639714311">ä½ ä¸çŸ¥é“çš„ Web Workers ï¼ˆä¸Šï¼‰[7.8K å­— | å¤šå›¾é¢„è­¦]</a>ï¼ˆ424+ ä¸ªğŸ‘ï¼‰</li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/6844904198639714311">ä½ ä¸çŸ¥é“çš„ Blob</a>ï¼ˆ215+ ä¸ªğŸ‘ï¼‰</li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/6844904198639714311">ä½ ä¸çŸ¥é“çš„ WeakMap</a>ï¼ˆ55+ ä¸ªğŸ‘ï¼‰</li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/6850037275579121671">ç©è½¬å‰ç«¯ Video æ’­æ”¾å™¨ | å¤šå›¾é¢„è­¦</a>ï¼ˆ708+ ä¸ªğŸ‘ï¼‰</li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/6846687590783909902">ç©è½¬å‰ç«¯äºŒè¿›åˆ¶</a>ï¼ˆ359+ ä¸ªğŸ‘ï¼‰</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬è¿›å…¥æ­£é¢˜ï¼Œä¸ºäº†è®©å¤§å®¶èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’ŒæŒæ¡ WebSocket æŠ€æœ¯ï¼Œæˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯ WebSocketã€‚</p>
<h3 id="ä¸€ã€ä»€ä¹ˆæ˜¯-WebSocket"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯-WebSocket" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯ WebSocket"></a>ä¸€ã€ä»€ä¹ˆæ˜¯ WebSocket</h3><h4 id="1-1-WebSocket-è¯ç”ŸèƒŒæ™¯"><a href="#1-1-WebSocket-è¯ç”ŸèƒŒæ™¯" class="headerlink" title="1.1 WebSocket è¯ç”ŸèƒŒæ™¯"></a>1.1 WebSocket è¯ç”ŸèƒŒæ™¯</h4><p>æ—©æœŸï¼Œå¾ˆå¤šç½‘ç«™ä¸ºäº†å®ç°æ¨é€æŠ€æœ¯ï¼Œæ‰€ç”¨çš„æŠ€æœ¯éƒ½æ˜¯è½®è¯¢ã€‚è½®è¯¢æ˜¯æŒ‡ç”±æµè§ˆå™¨æ¯éš”ä¸€æ®µæ—¶é—´å‘æœåŠ¡å™¨å‘å‡º HTTP è¯·æ±‚ï¼Œç„¶åæœåŠ¡å™¨è¿”å›æœ€æ–°çš„æ•°æ®ç»™å®¢æˆ·ç«¯ã€‚å¸¸è§çš„è½®è¯¢æ–¹å¼åˆ†ä¸ºè½®è¯¢ä¸é•¿è½®è¯¢ï¼Œå®ƒä»¬çš„åŒºåˆ«å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e1a4971badd?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>ä¸ºäº†æ›´åŠ ç›´è§‚æ„Ÿå—è½®è¯¢ä¸é•¿è½®è¯¢ä¹‹é—´çš„åŒºåˆ«ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„ä»£ç ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e1a49cab9d5?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>è¿™ç§ä¼ ç»Ÿçš„æ¨¡å¼å¸¦æ¥å¾ˆæ˜æ˜¾çš„ç¼ºç‚¹ï¼Œå³æµè§ˆå™¨éœ€è¦ä¸æ–­çš„å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œç„¶è€Œ HTTP è¯·æ±‚ä¸å“åº”å¯èƒ½ä¼šåŒ…å«è¾ƒé•¿çš„å¤´éƒ¨ï¼Œå…¶ä¸­çœŸæ­£æœ‰æ•ˆçš„æ•°æ®å¯èƒ½åªæ˜¯å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥è¿™æ ·ä¼šæ¶ˆè€—å¾ˆå¤šå¸¦å®½èµ„æºã€‚</p>
<p>æ¯”è¾ƒæ–°çš„è½®è¯¢æŠ€æœ¯æ˜¯ <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Comet_(web%E6%8A%80%E6%9C%AF)">Comet</a>ã€‚è¿™ç§æŠ€æœ¯è™½ç„¶å¯ä»¥å®ç°åŒå‘é€šä¿¡ï¼Œä½†ä»ç„¶éœ€è¦åå¤å‘å‡ºè¯·æ±‚ã€‚è€Œä¸”åœ¨ Comet ä¸­æ™®éé‡‡ç”¨çš„ HTTP é•¿è¿æ¥ä¹Ÿä¼šæ¶ˆè€—æœåŠ¡å™¨èµ„æºã€‚</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒHTML5 å®šä¹‰äº† WebSocket åè®®ï¼Œèƒ½æ›´å¥½çš„èŠ‚çœæœåŠ¡å™¨èµ„æºå’Œå¸¦å®½ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ›´å®æ—¶åœ°è¿›è¡Œé€šè®¯ã€‚Websocket ä½¿ç”¨ ws æˆ– wss çš„ç»Ÿä¸€èµ„æºæ ‡å¿—ç¬¦ï¼ˆURIï¼‰ï¼Œå…¶ä¸­ wss è¡¨ç¤ºä½¿ç”¨äº† TLS çš„ Websocketã€‚å¦‚ï¼š</p>
<pre><code>ws://echo.websocket.org
wss://echo.websocket.org
å¤åˆ¶ä»£ç </code></pre>
<p>WebSocket ä¸ HTTP å’Œ HTTPS ä½¿ç”¨ç›¸åŒçš„ TCP ç«¯å£ï¼Œå¯ä»¥ç»•è¿‡å¤§å¤šæ•°é˜²ç«å¢™çš„é™åˆ¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒWebSocket åè®®ä½¿ç”¨ 80 ç«¯å£ï¼›è‹¥è¿è¡Œåœ¨ TLS ä¹‹ä¸Šæ—¶ï¼Œé»˜è®¤ä½¿ç”¨ 443 ç«¯å£ã€‚</p>
<h4 id="1-2-WebSocket-ç®€ä»‹"><a href="#1-2-WebSocket-ç®€ä»‹" class="headerlink" title="1.2 WebSocket ç®€ä»‹"></a>1.2 WebSocket ç®€ä»‹</h4><p>WebSocket æ˜¯ä¸€ç§ç½‘ç»œä¼ è¾“åè®®ï¼Œå¯åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šä¿¡ï¼Œä½äº OSI æ¨¡å‹çš„åº”ç”¨å±‚ã€‚WebSocket åè®®åœ¨ 2011 å¹´ç”± IETF æ ‡å‡†åŒ–ä¸º <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6455">RFC 6455</a>ï¼Œåç”± <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7936">RFC 7936</a> è¡¥å……è§„èŒƒã€‚</p>
<p>WebSocket ä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—æ›´åŠ ç®€å•ï¼Œå…è®¸æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚åœ¨ WebSocket API ä¸­ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ã€‚</p>
<p>ä»‹ç»å®Œè½®è¯¢å’Œ WebSocket çš„ç›¸å…³å†…å®¹ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ XHR Polling ä¸ WebSocket ä¹‹é—´çš„åŒºåˆ«ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e1a49d7b0ad?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<h4 id="1-3-WebSocket-ä¼˜ç‚¹"><a href="#1-3-WebSocket-ä¼˜ç‚¹" class="headerlink" title="1.3 WebSocket ä¼˜ç‚¹"></a>1.3 WebSocket ä¼˜ç‚¹</h4><ul>
<li>è¾ƒå°‘çš„æ§åˆ¶å¼€é”€ã€‚åœ¨è¿æ¥åˆ›å»ºåï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´äº¤æ¢æ•°æ®æ—¶ï¼Œç”¨äºåè®®æ§åˆ¶çš„æ•°æ®åŒ…å¤´éƒ¨ç›¸å¯¹è¾ƒå°ã€‚</li>
<li>æ›´å¼ºçš„å®æ—¶æ€§ã€‚ç”±äºåè®®æ˜¯å…¨åŒå·¥çš„ï¼Œæ‰€ä»¥æœåŠ¡å™¨å¯ä»¥éšæ—¶ä¸»åŠ¨ç»™å®¢æˆ·ç«¯ä¸‹å‘æ•°æ®ã€‚ç›¸å¯¹äº HTTP è¯·æ±‚éœ€è¦ç­‰å¾…å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚æœåŠ¡ç«¯æ‰èƒ½å“åº”ï¼Œå»¶è¿Ÿæ˜æ˜¾æ›´å°‘ã€‚</li>
<li>ä¿æŒè¿æ¥çŠ¶æ€ã€‚ä¸ HTTP ä¸åŒçš„æ˜¯ï¼ŒWebSocket éœ€è¦å…ˆåˆ›å»ºè¿æ¥ï¼Œè¿™å°±ä½¿å¾—å…¶æˆä¸ºä¸€ç§æœ‰çŠ¶æ€çš„åè®®ï¼Œä¹‹åé€šä¿¡æ—¶å¯ä»¥çœç•¥éƒ¨åˆ†çŠ¶æ€ä¿¡æ¯ã€‚</li>
<li>æ›´å¥½çš„äºŒè¿›åˆ¶æ”¯æŒã€‚WebSocket å®šä¹‰äº†äºŒè¿›åˆ¶å¸§ï¼Œç›¸å¯¹ HTTPï¼Œå¯ä»¥æ›´è½»æ¾åœ°å¤„ç†äºŒè¿›åˆ¶å†…å®¹ã€‚</li>
<li>å¯ä»¥æ”¯æŒæ‰©å±•ã€‚WebSocket å®šä¹‰äº†æ‰©å±•ï¼Œç”¨æˆ·å¯ä»¥æ‰©å±•åè®®ã€å®ç°éƒ¨åˆ†è‡ªå®šä¹‰çš„å­åè®®ã€‚</li>
</ul>
<p>ç”±äº WebSocket æ‹¥æœ‰ä¸Šè¿°çš„ä¼˜ç‚¹ï¼Œæ‰€ä»¥å®ƒè¢«å¹¿æ³›åœ°åº”ç”¨åœ¨å³æ—¶é€šä¿¡ã€å®æ—¶éŸ³è§†é¢‘ã€åœ¨çº¿æ•™è‚²å’Œæ¸¸æˆç­‰é¢†åŸŸã€‚å¯¹äºå‰ç«¯å¼€å‘è€…æ¥è¯´ï¼Œè¦æƒ³ä½¿ç”¨ WebSocket æä¾›çš„å¼ºå¤§èƒ½åŠ›ï¼Œå°±å¿…é¡»å…ˆæŒæ¡ WebSocket APIï¼Œä¸‹é¢é˜¿å®å“¥å¸¦å¤§å®¶ä¸€èµ·æ¥è®¤è¯†ä¸€ä¸‹ WebSocket APIã€‚</p>
<h3 id="äºŒã€WebSocket-API"><a href="#äºŒã€WebSocket-API" class="headerlink" title="äºŒã€WebSocket API"></a>äºŒã€WebSocket API</h3><p>åœ¨ä»‹ç» WebSocket API ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹å®ƒçš„å…¼å®¹æ€§ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e1a4c1ef050?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>ï¼ˆå›¾ç‰‡æ¥æºï¼š<a target="_blank" rel="noopener" href="https://caniuse.com/#search=WebSocket%EF%BC%89">https://caniuse.com/#search=WebSocketï¼‰</a></p>
<p>ä»ä¸Šå›¾å¯çŸ¥ï¼Œç›®å‰ä¸»æµçš„ Web æµè§ˆå™¨éƒ½æ”¯æŒ WebSocketï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å¤§å¤šæ•°é¡¹ç›®ä¸­æ”¾å¿ƒåœ°ä½¿ç”¨å®ƒã€‚</p>
<p>åœ¨æµè§ˆå™¨ä¸­è¦ä½¿ç”¨ WebSocket æä¾›çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å°±å¿…é¡»å…ˆåˆ›å»º WebSocket å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æä¾›äº†ç”¨äºåˆ›å»ºå’Œç®¡ç† WebSocket è¿æ¥ï¼Œä»¥åŠå¯ä»¥é€šè¿‡è¯¥è¿æ¥å‘é€å’Œæ¥æ”¶æ•°æ®çš„ APIã€‚</p>
<p>ä½¿ç”¨ WebSocket æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å°±èƒ½è½»æ˜“åœ°æ„é€ ä¸€ä¸ª WebSocket å¯¹è±¡ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä» WebSocket æ„é€ å‡½æ•°ã€WebSocket å¯¹è±¡çš„å±æ€§ã€æ–¹æ³•åŠ WebSocket ç›¸å…³çš„äº‹ä»¶å››ä¸ªæ–¹é¢æ¥ä»‹ç» WebSocket APIï¼Œé¦–å…ˆæˆ‘ä»¬ä» WebSocket çš„æ„é€ å‡½æ•°å…¥æ‰‹ï¼š</p>
<h4 id="2-1-æ„é€ å‡½æ•°"><a href="#2-1-æ„é€ å‡½æ•°" class="headerlink" title="2.1 æ„é€ å‡½æ•°"></a>2.1 æ„é€ å‡½æ•°</h4><p>WebSocket æ„é€ å‡½æ•°çš„è¯­æ³•ä¸ºï¼š</p>
<pre><code>const myWebSocket = new WebSocket(url [, protocols]);
å¤åˆ¶ä»£ç </code></pre>
<p>ç›¸å…³å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li>urlï¼šè¡¨ç¤ºè¿æ¥çš„ URLï¼Œè¿™æ˜¯ WebSocket æœåŠ¡å™¨å°†å“åº”çš„ URLã€‚</li>
<li>protocolsï¼ˆå¯é€‰ï¼‰ï¼šä¸€ä¸ªåè®®å­—ç¬¦ä¸²æˆ–è€…ä¸€ä¸ªåŒ…å«åè®®å­—ç¬¦ä¸²çš„æ•°ç»„ã€‚è¿™äº›å­—ç¬¦ä¸²ç”¨äºæŒ‡å®šå­åè®®ï¼Œè¿™æ ·å•ä¸ªæœåŠ¡å™¨å¯ä»¥å®ç°å¤šä¸ª WebSocket å­åè®®ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½å¸Œæœ›ä¸€å°æœåŠ¡å™¨èƒ½å¤Ÿæ ¹æ®æŒ‡å®šçš„åè®®ï¼ˆprotocolï¼‰å¤„ç†ä¸åŒç±»å‹çš„äº¤äº’ã€‚å¦‚æœä¸æŒ‡å®šåè®®å­—ç¬¦ä¸²ï¼Œåˆ™å‡å®šä¸ºç©ºå­—ç¬¦ä¸²ã€‚</li>
</ul>
<p>å½“å°è¯•è¿æ¥çš„ç«¯å£è¢«é˜»æ­¢æ—¶ï¼Œä¼šæŠ›å‡º <code>SECURITY_ERR</code> å¼‚å¸¸ã€‚</p>
<h4 id="2-2-å±æ€§"><a href="#2-2-å±æ€§" class="headerlink" title="2.2 å±æ€§"></a>2.2 å±æ€§</h4><p>WebSocket å¯¹è±¡åŒ…å«ä»¥ä¸‹å±æ€§ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e1a4c51c721?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>æ¯ä¸ªå±æ€§çš„å…·ä½“å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>binaryTypeï¼šä½¿ç”¨äºŒè¿›åˆ¶çš„æ•°æ®ç±»å‹è¿æ¥ã€‚</p>
</li>
<li><p>bufferedAmountï¼ˆåªè¯»ï¼‰ï¼šæœªå‘é€è‡³æœåŠ¡å™¨çš„å­—èŠ‚æ•°ã€‚</p>
</li>
<li><p>extensionsï¼ˆåªè¯»ï¼‰ï¼šæœåŠ¡å™¨é€‰æ‹©çš„æ‰©å±•ã€‚</p>
</li>
<li><p>oncloseï¼šç”¨äºæŒ‡å®šè¿æ¥å…³é—­åçš„å›è°ƒå‡½æ•°ã€‚</p>
</li>
<li><p>onerrorï¼šç”¨äºæŒ‡å®šè¿æ¥å¤±è´¥åçš„å›è°ƒå‡½æ•°ã€‚</p>
</li>
<li><p>onmessageï¼šç”¨äºæŒ‡å®šå½“ä»æœåŠ¡å™¨æ¥å—åˆ°ä¿¡æ¯æ—¶çš„å›è°ƒå‡½æ•°ã€‚</p>
</li>
<li><p>onopenï¼šç”¨äºæŒ‡å®šè¿æ¥æˆåŠŸåçš„å›è°ƒå‡½æ•°ã€‚</p>
</li>
<li><p>protocolï¼ˆåªè¯»ï¼‰ï¼šç”¨äºè¿”å›æœåŠ¡å™¨ç«¯é€‰ä¸­çš„å­åè®®çš„åå­—ã€‚</p>
</li>
<li><p>readyStateï¼ˆåªè¯»ï¼‰ï¼šè¿”å›å½“å‰ WebSocket çš„è¿æ¥çŠ¶æ€ï¼Œå…±æœ‰ 4 ç§çŠ¶æ€ï¼š</p>
<ul>
<li>CONNECTING â€” æ­£åœ¨è¿æ¥ä¸­ï¼Œå¯¹åº”çš„å€¼ä¸º 0ï¼›</li>
<li>OPEN â€” å·²ç»è¿æ¥å¹¶ä¸”å¯ä»¥é€šè®¯ï¼Œå¯¹åº”çš„å€¼ä¸º 1ï¼›</li>
<li>CLOSING â€” è¿æ¥æ­£åœ¨å…³é—­ï¼Œå¯¹åº”çš„å€¼ä¸º 2ï¼›</li>
<li>CLOSED â€” è¿æ¥å·²å…³é—­æˆ–è€…æ²¡æœ‰è¿æ¥æˆåŠŸï¼Œå¯¹åº”çš„å€¼ä¸º 3ã€‚</li>
</ul>
</li>
<li><p>urlï¼ˆåªè¯»ï¼‰ï¼šè¿”å›å€¼ä¸ºå½“æ„é€ å‡½æ•°åˆ›å»º WebSocket å®ä¾‹å¯¹è±¡æ—¶ URL çš„ç»å¯¹è·¯å¾„ã€‚</p>
</li>
</ul>
<h4 id="2-3-æ–¹æ³•"><a href="#2-3-æ–¹æ³•" class="headerlink" title="2.3 æ–¹æ³•"></a>2.3 æ–¹æ³•</h4><ul>
<li>close([code[, reason]])ï¼šè¯¥æ–¹æ³•ç”¨äºå…³é—­ WebSocket è¿æ¥ï¼Œå¦‚æœè¿æ¥å·²ç»å…³é—­ï¼Œåˆ™æ­¤æ–¹æ³•ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚</li>
<li>send(data)ï¼šè¯¥æ–¹æ³•å°†éœ€è¦é€šè¿‡ WebSocket é“¾æ¥ä¼ è¾“è‡³æœåŠ¡å™¨çš„æ•°æ®æ’å…¥é˜Ÿåˆ—ï¼Œå¹¶æ ¹æ®æ‰€éœ€è¦ä¼ è¾“çš„æ•°æ®çš„å¤§å°æ¥å¢åŠ  bufferedAmount çš„å€¼ ã€‚è‹¥æ•°æ®æ— æ³•ä¼ è¾“ï¼ˆæ¯”å¦‚æ•°æ®éœ€è¦ç¼“å­˜è€Œç¼“å†²åŒºå·²æ»¡ï¼‰æ—¶ï¼Œå¥—æ¥å­—ä¼šè‡ªè¡Œå…³é—­ã€‚</li>
</ul>
<h4 id="2-4-äº‹ä»¶"><a href="#2-4-äº‹ä»¶" class="headerlink" title="2.4 äº‹ä»¶"></a>2.4 äº‹ä»¶</h4><p>ä½¿ç”¨ addEventListener() æˆ–å°†ä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨èµ‹å€¼ç»™ WebSocket å¯¹è±¡çš„ oneventname å±æ€§ï¼Œæ¥ç›‘å¬ä¸‹é¢çš„äº‹ä»¶ã€‚</p>
<ul>
<li>closeï¼šå½“ä¸€ä¸ª WebSocket è¿æ¥è¢«å…³é—­æ—¶è§¦å‘ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ onclose å±æ€§æ¥è®¾ç½®ã€‚</li>
<li>errorï¼šå½“ä¸€ä¸ª WebSocket è¿æ¥å› é”™è¯¯è€Œå…³é—­æ—¶è§¦å‘ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ onerror å±æ€§æ¥è®¾ç½®ã€‚</li>
<li>messageï¼šå½“é€šè¿‡ WebSocket æ”¶åˆ°æ•°æ®æ—¶è§¦å‘ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ onmessage å±æ€§æ¥è®¾ç½®ã€‚</li>
<li>openï¼šå½“ä¸€ä¸ª WebSocket è¿æ¥æˆåŠŸæ—¶è§¦å‘ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ onopen å±æ€§æ¥è®¾ç½®ã€‚</li>
</ul>
<p>ä»‹ç»å®Œ WebSocket APIï¼Œæˆ‘ä»¬æ¥ä¸¾ä¸€ä¸ªä½¿ç”¨ WebSocket å‘é€æ™®é€šæ–‡æœ¬çš„ç¤ºä¾‹ã€‚</p>
<h4 id="2-5-å‘é€æ™®é€šæ–‡æœ¬"><a href="#2-5-å‘é€æ™®é€šæ–‡æœ¬" class="headerlink" title="2.5 å‘é€æ™®é€šæ–‡æœ¬"></a>2.5 å‘é€æ™®é€šæ–‡æœ¬</h4><p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e1a4c7a5bee?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>åœ¨ä»¥ä¸Šç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨é¡µé¢ä¸Šåˆ›å»ºäº†ä¸¤ä¸ª textareaï¼Œåˆ†åˆ«ç”¨äºå­˜æ”¾ <strong>å¾…å‘é€çš„æ•°æ®</strong> å’Œ <strong>æœåŠ¡å™¨è¿”å›çš„æ•°æ®</strong>ã€‚å½“ç”¨æˆ·è¾“å…¥å®Œå¾…å‘é€çš„æ–‡æœ¬ä¹‹åï¼Œç‚¹å‡» <strong>å‘é€</strong> æŒ‰é’®æ—¶ä¼šæŠŠè¾“å…¥çš„æ–‡æœ¬å‘é€åˆ°æœåŠ¡ç«¯ï¼Œè€ŒæœåŠ¡ç«¯æˆåŠŸæ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œä¼šæŠŠæ”¶åˆ°çš„æ¶ˆæ¯åŸå°ä¸åŠ¨åœ°å›ä¼ åˆ°å®¢æˆ·ç«¯ã€‚</p>
<pre><code>// const socket = new WebSocket("ws://echo.websocket.org");
// const sendMsgContainer = document.querySelector("#sendMessage");
function send() &amp;#123;
  const message = sendMsgContainer.value;
  if (socket.readyState !== WebSocket.OPEN) &amp;#123;
    console.log("è¿æ¥æœªå»ºç«‹ï¼Œè¿˜ä¸èƒ½å‘é€æ¶ˆæ¯");
    return;
  &amp;#125;
  if (message) socket.send(message);
&amp;#125;
å¤åˆ¶ä»£ç </code></pre>
<p>å½“ç„¶å®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡ç«¯è¿”å›çš„æ¶ˆæ¯ä¹‹åï¼Œä¼šæŠŠå¯¹åº”çš„æ–‡æœ¬å†…å®¹ä¿å­˜åˆ° <strong>æ¥æ”¶çš„æ•°æ®</strong> å¯¹åº”çš„ textarea æ–‡æœ¬æ¡†ä¸­ã€‚</p>
<pre><code>// const socket = new WebSocket("ws://echo.websocket.org");
// const receivedMsgContainer = document.querySelector("#receivedMessage");    
socket.addEventListener("message", function (event) &amp;#123;
  console.log("Message from server ", event.data);
  receivedMsgContainer.value = event.data;
&amp;#125;);
å¤åˆ¶ä»£ç </code></pre>
<p>ä¸ºäº†æ›´åŠ ç›´è§‚åœ°ç†è§£ä¸Šè¿°çš„æ•°æ®äº¤äº’è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ Chrome æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·æ¥çœ‹ä¸€ä¸‹ç›¸åº”çš„è¿‡ç¨‹ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e1907772eaa?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>ä»¥ä¸Šç¤ºä¾‹å¯¹åº”çš„å®Œæ•´ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset="UTF-8" /&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /&gt;
    &lt;title&gt;WebSocket å‘é€æ™®é€šæ–‡æœ¬ç¤ºä¾‹&lt;/title&gt;
    &lt;style&gt;
      .block &amp;#123;
        flex: 1;
      &amp;#125;
    &lt;/style&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h3&gt;é˜¿å®å“¥ï¼šWebSocket å‘é€æ™®é€šæ–‡æœ¬ç¤ºä¾‹&lt;/h3&gt;
    &lt;div style="display: flex;"&gt;
      &lt;div class="block"&gt;
        &lt;p&gt;å³å°†å‘é€çš„æ•°æ®ï¼š&lt;button onclick="send()"&gt;å‘é€&lt;/button&gt;&lt;/p&gt;
        &lt;textarea id="sendMessage" rows="5" cols="15"&gt;&lt;/textarea&gt;
      &lt;/div&gt;
      &lt;div class="block"&gt;
        &lt;p&gt;æ¥æ”¶çš„æ•°æ®ï¼š&lt;/p&gt;
        &lt;textarea id="receivedMessage" rows="5" cols="15"&gt;&lt;/textarea&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
      const sendMsgContainer = document.querySelector("#sendMessage");
      const receivedMsgContainer = document.querySelector("#receivedMessage");
      const socket = new WebSocket("ws://echo.websocket.org");

      // ç›‘å¬è¿æ¥æˆåŠŸäº‹ä»¶
      socket.addEventListener("open", function (event) &amp;#123;
        console.log("è¿æ¥æˆåŠŸï¼Œå¯ä»¥å¼€å§‹é€šè®¯");
      &amp;#125;);

      // ç›‘å¬æ¶ˆæ¯
      socket.addEventListener("message", function (event) &amp;#123;
        console.log("Message from server ", event.data);
        receivedMsgContainer.value = event.data;
      &amp;#125;);

      function send() &amp;#123;
        const message = sendMsgContainer.value;
        if (socket.readyState !== WebSocket.OPEN) &amp;#123;
          console.log("è¿æ¥æœªå»ºç«‹ï¼Œè¿˜ä¸èƒ½å‘é€æ¶ˆæ¯");
          return;
        &amp;#125;
        if (message) socket.send(message);
      &amp;#125;
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
å¤åˆ¶ä»£ç </code></pre>
<p>å…¶å® WebSocket é™¤äº†æ”¯æŒå‘é€æ™®é€šçš„æ–‡æœ¬ä¹‹å¤–ï¼Œå®ƒè¿˜æ”¯æŒå‘é€äºŒè¿›åˆ¶æ•°æ®ï¼Œæ¯”å¦‚ ArrayBuffer å¯¹è±¡ã€Blob å¯¹è±¡æˆ–è€… ArrayBufferView å¯¹è±¡ï¼š</p>
<pre><code>const socket = new WebSocket("ws://echo.websocket.org");
socket.onopen = function () &amp;#123;
  // å‘é€UTF-8ç¼–ç çš„æ–‡æœ¬ä¿¡æ¯
  socket.send("Hello Echo Server!");
  // å‘é€UTF-8ç¼–ç çš„JSONæ•°æ®
  socket.send(JSON.stringify(&amp;#123; msg: "æˆ‘æ˜¯é˜¿å®å“¥" &amp;#125;));

  // å‘é€äºŒè¿›åˆ¶ArrayBuffer
  const buffer = new ArrayBuffer(128);
  socket.send(buffer);

  // å‘é€äºŒè¿›åˆ¶ArrayBufferView
  const intview = new Uint32Array(buffer);
  socket.send(intview);

  // å‘é€äºŒè¿›åˆ¶Blob
  const blob = new Blob([buffer]);
  socket.send(blob);
&amp;#125;;
å¤åˆ¶ä»£ç </code></pre>
<p>ä»¥ä¸Šä»£ç æˆåŠŸè¿è¡Œåï¼Œé€šè¿‡ Chrome å¼€å‘è€…å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹åº”çš„æ•°æ®äº¤äº’è¿‡ç¨‹ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e1906c605c4?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>ä¸‹é¢é˜¿å®å“¥ä»¥å‘é€ Blob å¯¹è±¡ä¸ºä¾‹ï¼Œæ¥ä»‹ç»ä¸€ä¸‹å¦‚ä½•å‘é€äºŒè¿›åˆ¶æ•°æ®ã€‚</p>
<blockquote>
<p>Blobï¼ˆBinary Large Objectï¼‰è¡¨ç¤ºäºŒè¿›åˆ¶ç±»å‹çš„å¤§å¯¹è±¡ã€‚åœ¨æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ï¼Œå°†äºŒè¿›åˆ¶æ•°æ®å­˜å‚¨ä¸ºä¸€ä¸ªå•ä¸€ä¸ªä½“çš„é›†åˆã€‚Blob é€šå¸¸æ˜¯å½±åƒã€å£°éŸ³æˆ–å¤šåª’ä½“æ–‡ä»¶ã€‚<strong>åœ¨ JavaScript ä¸­ Blob ç±»å‹çš„å¯¹è±¡è¡¨ç¤ºä¸å¯å˜çš„ç±»ä¼¼æ–‡ä»¶å¯¹è±¡çš„åŸå§‹æ•°æ®ã€‚</strong></p>
<p>å¯¹ Blob æ„Ÿå…´è¶£çš„å°ä¼™ä¼´ï¼Œå¯ä»¥é˜…è¯» <a target="_blank" rel="noopener" href="https://juejin.im/post/6844904178725158926">â€œä½ ä¸çŸ¥é“çš„ Blobâ€</a> è¿™ç¯‡æ–‡ç« ã€‚</p>
</blockquote>
<h4 id="2-6-å‘é€äºŒè¿›åˆ¶æ•°æ®"><a href="#2-6-å‘é€äºŒè¿›åˆ¶æ•°æ®" class="headerlink" title="2.6 å‘é€äºŒè¿›åˆ¶æ•°æ®"></a>2.6 å‘é€äºŒè¿›åˆ¶æ•°æ®</h4><p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e1907e4cb3e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>åœ¨ä»¥ä¸Šç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨é¡µé¢ä¸Šåˆ›å»ºäº†ä¸¤ä¸ª textareaï¼Œåˆ†åˆ«ç”¨äºå­˜æ”¾ <strong>å¾…å‘é€çš„æ•°æ®</strong> å’Œ <strong>æœåŠ¡å™¨è¿”å›çš„æ•°æ®</strong>ã€‚å½“ç”¨æˆ·è¾“å…¥å®Œå¾…å‘é€çš„æ–‡æœ¬ä¹‹åï¼Œç‚¹å‡» <strong>å‘é€</strong> æŒ‰é’®æ—¶ï¼Œæˆ‘ä»¬ä¼šå…ˆè·å–è¾“å…¥çš„æ–‡æœ¬å¹¶æŠŠæ–‡æœ¬åŒ…è£…æˆ Blob å¯¹è±¡ç„¶åå‘é€åˆ°æœåŠ¡ç«¯ï¼Œè€ŒæœåŠ¡ç«¯æˆåŠŸæ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œä¼šæŠŠæ”¶åˆ°çš„æ¶ˆæ¯åŸå°ä¸åŠ¨åœ°å›ä¼ åˆ°å®¢æˆ·ç«¯ã€‚</p>
<p>å½“æµè§ˆå™¨æ¥æ”¶åˆ°æ–°æ¶ˆæ¯åï¼Œå¦‚æœæ˜¯æ–‡æœ¬æ•°æ®ï¼Œä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢æˆ DOMString å¯¹è±¡ï¼Œå¦‚æœæ˜¯äºŒè¿›åˆ¶æ•°æ®æˆ– Blob å¯¹è±¡ï¼Œä¼šç›´æ¥å°†å…¶è½¬äº¤ç»™åº”ç”¨ï¼Œç”±åº”ç”¨è‡ªèº«æ¥æ ¹æ®è¿”å›çš„æ•°æ®ç±»å‹è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚</p>
<p><strong>æ•°æ®å‘é€ä»£ç </strong></p>
<pre><code>// const socket = new WebSocket("ws://echo.websocket.org");
// const sendMsgContainer = document.querySelector("#sendMessage");
function send() &amp;#123;
  const message = sendMsgContainer.value;
  if (socket.readyState !== WebSocket.OPEN) &amp;#123;
    console.log("è¿æ¥æœªå»ºç«‹ï¼Œè¿˜ä¸èƒ½å‘é€æ¶ˆæ¯");
    return;
  &amp;#125;
  const blob = new Blob([message], &amp;#123; type: "text/plain" &amp;#125;);
  if (message) socket.send(blob);
  console.log(`æœªå‘é€è‡³æœåŠ¡å™¨çš„å­—èŠ‚æ•°ï¼š$&amp;#123;socket.bufferedAmount&amp;#125;`);
&amp;#125;
å¤åˆ¶ä»£ç </code></pre>
<p>å½“ç„¶å®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡ç«¯è¿”å›çš„æ¶ˆæ¯ä¹‹åï¼Œä¼šåˆ¤æ–­è¿”å›çš„æ•°æ®ç±»å‹ï¼Œå¦‚æœæ˜¯ Blob ç±»å‹çš„è¯ï¼Œä¼šè°ƒç”¨ Blob å¯¹è±¡çš„ text() æ–¹æ³•ï¼Œè·å– Blob å¯¹è±¡ä¸­ä¿å­˜çš„ UTF-8 æ ¼å¼çš„å†…å®¹ï¼Œç„¶åæŠŠå¯¹åº”çš„æ–‡æœ¬å†…å®¹ä¿å­˜åˆ° <strong>æ¥æ”¶çš„æ•°æ®</strong> å¯¹åº”çš„ textarea æ–‡æœ¬æ¡†ä¸­ã€‚</p>
<p><strong>æ•°æ®æ¥æ”¶ä»£ç </strong></p>
<pre><code>// const socket = new WebSocket("ws://echo.websocket.org");
// const receivedMsgContainer = document.querySelector("#receivedMessage");
socket.addEventListener("message", async function (event) &amp;#123;
  console.log("Message from server ", event.data);
  const receivedData = event.data;
  if (receivedData instanceof Blob) &amp;#123;
    receivedMsgContainer.value = await receivedData.text();
  &amp;#125; else &amp;#123;
    receivedMsgContainer.value = receivedData;
  &amp;#125;
 &amp;#125;);
å¤åˆ¶ä»£ç </code></pre>
<p>åŒæ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨ Chrome æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·æ¥çœ‹ä¸€ä¸‹ç›¸åº”çš„è¿‡ç¨‹ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e1912c4f2e5?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾åœ°çœ‹åˆ°ï¼Œå½“ä½¿ç”¨å‘é€ Blob å¯¹è±¡æ—¶ï¼ŒData æ ä½çš„ä¿¡æ¯æ˜¾ç¤ºçš„æ˜¯ <strong>Binary Message</strong>ï¼Œè€Œå¯¹äºå‘é€æ™®é€šæ–‡æœ¬æ¥è¯´ï¼ŒData æ ä½çš„ä¿¡æ¯æ˜¯ç›´æ¥æ˜¾ç¤ºå‘é€çš„æ–‡æœ¬æ¶ˆæ¯ã€‚</p>
<p>ä»¥ä¸Šç¤ºä¾‹å¯¹åº”çš„å®Œæ•´ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset="UTF-8" /&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /&gt;
    &lt;title&gt;WebSocket å‘é€äºŒè¿›åˆ¶æ•°æ®ç¤ºä¾‹&lt;/title&gt;
    &lt;style&gt;
      .block &amp;#123;
        flex: 1;
      &amp;#125;
    &lt;/style&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h3&gt;é˜¿å®å“¥ï¼šWebSocket å‘é€äºŒè¿›åˆ¶æ•°æ®ç¤ºä¾‹&lt;/h3&gt;
    &lt;div style="display: flex;"&gt;
      &lt;div class="block"&gt;
        &lt;p&gt;å¾…å‘é€çš„æ•°æ®ï¼š&lt;button onclick="send()"&gt;å‘é€&lt;/button&gt;&lt;/p&gt;
        &lt;textarea id="sendMessage" rows="5" cols="15"&gt;&lt;/textarea&gt;
      &lt;/div&gt;
      &lt;div class="block"&gt;
        &lt;p&gt;æ¥æ”¶çš„æ•°æ®ï¼š&lt;/p&gt;
        &lt;textarea id="receivedMessage" rows="5" cols="15"&gt;&lt;/textarea&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
      const sendMsgContainer = document.querySelector("#sendMessage");
      const receivedMsgContainer = document.querySelector("#receivedMessage");
      const socket = new WebSocket("ws://echo.websocket.org");

      // ç›‘å¬è¿æ¥æˆåŠŸäº‹ä»¶
      socket.addEventListener("open", function (event) &amp;#123;
        console.log("è¿æ¥æˆåŠŸï¼Œå¯ä»¥å¼€å§‹é€šè®¯");
      &amp;#125;);

      // ç›‘å¬æ¶ˆæ¯
      socket.addEventListener("message", async function (event) &amp;#123;
        console.log("Message from server ", event.data);
        const receivedData = event.data;
        if (receivedData instanceof Blob) &amp;#123;
          receivedMsgContainer.value = await receivedData.text();
        &amp;#125; else &amp;#123;
          receivedMsgContainer.value = receivedData;
        &amp;#125;
      &amp;#125;);

      function send() &amp;#123;
        const message = sendMsgContainer.value;
        if (socket.readyState !== WebSocket.OPEN) &amp;#123;
          console.log("è¿æ¥æœªå»ºç«‹ï¼Œè¿˜ä¸èƒ½å‘é€æ¶ˆæ¯");
          return;
        &amp;#125;
        const blob = new Blob([message], &amp;#123; type: "text/plain" &amp;#125;);
        if (message) socket.send(blob);
        console.log(`æœªå‘é€è‡³æœåŠ¡å™¨çš„å­—èŠ‚æ•°ï¼š$&amp;#123;socket.bufferedAmount&amp;#125;`);
      &amp;#125;
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
å¤åˆ¶ä»£ç </code></pre>
<p>å¯èƒ½æœ‰ä¸€äº›å°ä¼™ä¼´äº†è§£å®Œ WebSocket API ä¹‹åï¼Œè§‰å¾—è¿˜ä¸å¤Ÿè¿‡ç˜¾ã€‚ä¸‹é¢é˜¿å®å“¥å°†å¸¦å¤§å®¶æ¥å®ç°ä¸€ä¸ªæ”¯æŒå‘é€æ™®é€šæ–‡æœ¬çš„ WebSocket æœåŠ¡å™¨ã€‚</p>
<h3 id="ä¸‰ã€æ‰‹å†™-WebSocket-æœåŠ¡å™¨"><a href="#ä¸‰ã€æ‰‹å†™-WebSocket-æœåŠ¡å™¨" class="headerlink" title="ä¸‰ã€æ‰‹å†™ WebSocket æœåŠ¡å™¨"></a>ä¸‰ã€æ‰‹å†™ WebSocket æœåŠ¡å™¨</h3><p>åœ¨ä»‹ç»å¦‚ä½•æ‰‹å†™ WebSocket æœåŠ¡å™¨å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹ WebSocket è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e192b2cc1a2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>ä»ä¸Šå›¾å¯çŸ¥ï¼Œåœ¨ä½¿ç”¨ WebSocket å®ç°å…¨åŒå·¥é€šä¿¡ä¹‹å‰ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´éœ€è¦å…ˆè¿›è¡Œæ¡æ‰‹ï¼ˆHandshakeï¼‰ï¼Œåœ¨å®Œæˆæ¡æ‰‹ä¹‹åæ‰èƒ½å¼€å§‹è¿›è¡Œæ•°æ®çš„åŒå‘é€šä¿¡ã€‚</p>
<p>æ¡æ‰‹æ˜¯åœ¨é€šä¿¡ç”µè·¯åˆ›å»ºä¹‹åï¼Œä¿¡æ¯ä¼ è¾“å¼€å§‹ä¹‹å‰ã€‚<strong>æ¡æ‰‹ç”¨äºè¾¾æˆå‚æ•°ï¼Œå¦‚ä¿¡æ¯ä¼ è¾“ç‡ï¼Œå­—æ¯è¡¨ï¼Œå¥‡å¶æ ¡éªŒï¼Œä¸­æ–­è¿‡ç¨‹ï¼Œå’Œå…¶ä»–åè®®ç‰¹æ€§ã€‚</strong> æ¡æ‰‹æœ‰åŠ©äºä¸åŒç»“æ„çš„ç³»ç»Ÿæˆ–è®¾å¤‡åœ¨é€šä¿¡ä¿¡é“ä¸­è¿æ¥ï¼Œè€Œä¸éœ€è¦äººä¸ºè®¾ç½®å‚æ•°ã€‚</p>
<p>æ—¢ç„¶æ¡æ‰‹æ˜¯ WebSocket è¿æ¥ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ä¸€ä¸ªç¯èŠ‚ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å…ˆæ¥åˆ†æ WebSocket çš„æ¡æ‰‹åè®®ã€‚</p>
<h4 id="3-1-æ¡æ‰‹åè®®"><a href="#3-1-æ¡æ‰‹åè®®" class="headerlink" title="3.1 æ¡æ‰‹åè®®"></a>3.1 æ¡æ‰‹åè®®</h4><p>WebSocket åè®®å±äºåº”ç”¨å±‚åè®®ï¼Œå®ƒä¾èµ–äºä¼ è¾“å±‚çš„ TCP åè®®ã€‚WebSocket é€šè¿‡ HTTP/1.1 åè®®çš„ <strong>101</strong> çŠ¶æ€ç è¿›è¡Œæ¡æ‰‹ã€‚ä¸ºäº†åˆ›å»º WebSocket è¿æ¥ï¼Œéœ€è¦é€šè¿‡æµè§ˆå™¨å‘å‡ºè¯·æ±‚ï¼Œä¹‹åæœåŠ¡å™¨è¿›è¡Œå›åº”ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šå¸¸ç§°ä¸º â€œæ¡æ‰‹â€ï¼ˆHandshakingï¼‰ã€‚</p>
<p>åˆ©ç”¨ HTTP å®Œæˆæ¡æ‰‹æœ‰å‡ ä¸ªå¥½å¤„ã€‚é¦–å…ˆï¼Œè®© WebSocket ä¸ç°æœ‰ HTTP åŸºç¡€è®¾æ–½å…¼å®¹ï¼šä½¿å¾— WebSocket æœåŠ¡å™¨å¯ä»¥è¿è¡Œåœ¨ 80 å’Œ 443 ç«¯å£ä¸Šï¼Œè¿™é€šå¸¸æ˜¯å¯¹å®¢æˆ·ç«¯å”¯ä¸€å¼€æ”¾çš„ç«¯å£ã€‚å…¶æ¬¡ï¼Œè®©æˆ‘ä»¬å¯ä»¥é‡ç”¨å¹¶æ‰©å±• HTTP çš„ Upgrade æµï¼Œä¸ºå…¶æ·»åŠ è‡ªå®šä¹‰çš„ WebSocket é¦–éƒ¨ï¼Œä»¥å®Œæˆåå•†ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ä»¥å‰é¢å·²ç»æ¼”ç¤ºè¿‡çš„å‘é€æ™®é€šæ–‡æœ¬çš„ä¾‹å­ä¸ºä¾‹ï¼Œæ¥å…·ä½“åˆ†æä¸€ä¸‹æ¡æ‰‹è¿‡ç¨‹ã€‚</p>
<h5 id="3-1-1-å®¢æˆ·ç«¯è¯·æ±‚"><a href="#3-1-1-å®¢æˆ·ç«¯è¯·æ±‚" class="headerlink" title="3.1.1 å®¢æˆ·ç«¯è¯·æ±‚"></a>3.1.1 å®¢æˆ·ç«¯è¯·æ±‚</h5><pre><code>GET ws://echo.websocket.org/ HTTP/1.1
Host: echo.websocket.org
Origin: file://
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: Zx8rNEkBE4xnwifpuh8DHQ==
Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits
å¤åˆ¶ä»£ç </code></pre>
<blockquote>
<p>å¤‡æ³¨ï¼šå·²å¿½ç•¥éƒ¨åˆ† HTTP è¯·æ±‚å¤´</p>
</blockquote>
<p><strong>å­—æ®µè¯´æ˜</strong></p>
<ul>
<li>Connection å¿…é¡»è®¾ç½® Upgradeï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å¸Œæœ›è¿æ¥å‡çº§ã€‚</li>
<li>Upgrade å­—æ®µå¿…é¡»è®¾ç½® websocketï¼Œè¡¨ç¤ºå¸Œæœ›å‡çº§åˆ° WebSocket åè®®ã€‚</li>
<li>Sec-WebSocket-Version è¡¨ç¤ºæ”¯æŒçš„ WebSocket ç‰ˆæœ¬ã€‚RFC6455 è¦æ±‚ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ 13ï¼Œä¹‹å‰è‰æ¡ˆçš„ç‰ˆæœ¬å‡åº”å½“å¼ƒç”¨ã€‚</li>
<li>Sec-WebSocket-Key æ˜¯éšæœºçš„å­—ç¬¦ä¸²ï¼ŒæœåŠ¡å™¨ç«¯ä¼šç”¨è¿™äº›æ•°æ®æ¥æ„é€ å‡ºä¸€ä¸ª SHA-1 çš„ä¿¡æ¯æ‘˜è¦ã€‚æŠŠ â€œSec-WebSocket-Keyâ€ åŠ ä¸Šä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ä¸² <strong>â€œ258EAFA5-E914-47DA-95CA-C5AB0DC85B11â€</strong>ï¼Œç„¶åè®¡ç®— SHA-1 æ‘˜è¦ï¼Œä¹‹åè¿›è¡Œ Base64 ç¼–ç ï¼Œå°†ç»“æœåšä¸º â€œSec-WebSocket-Acceptâ€ å¤´çš„å€¼ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¦‚æ­¤æ“ä½œï¼Œå¯ä»¥å°½é‡é¿å…æ™®é€š HTTP è¯·æ±‚è¢«è¯¯è®¤ä¸º WebSocket åè®®ã€‚</li>
<li>Sec-WebSocket-Extensions ç”¨äºåå•†æœ¬æ¬¡è¿æ¥è¦ä½¿ç”¨çš„ WebSocket æ‰©å±•ï¼šå®¢æˆ·ç«¯å‘é€æ”¯æŒçš„æ‰©å±•ï¼ŒæœåŠ¡å™¨é€šè¿‡è¿”å›ç›¸åŒçš„é¦–éƒ¨ç¡®è®¤è‡ªå·±æ”¯æŒä¸€ä¸ªæˆ–å¤šä¸ªæ‰©å±•ã€‚</li>
<li>Origin å­—æ®µæ˜¯å¯é€‰çš„ï¼Œé€šå¸¸ç”¨æ¥è¡¨ç¤ºåœ¨æµè§ˆå™¨ä¸­å‘èµ·æ­¤ WebSocket è¿æ¥æ‰€åœ¨çš„é¡µé¢ï¼Œç±»ä¼¼äº Refererã€‚ä½†æ˜¯ï¼Œä¸ Referer ä¸åŒçš„æ˜¯ï¼ŒOrigin åªåŒ…å«äº†åè®®å’Œä¸»æœºåç§°ã€‚</li>
</ul>
<h5 id="3-1-2-æœåŠ¡ç«¯å“åº”"><a href="#3-1-2-æœåŠ¡ç«¯å“åº”" class="headerlink" title="3.1.2 æœåŠ¡ç«¯å“åº”"></a>3.1.2 æœåŠ¡ç«¯å“åº”</h5><pre><code>HTTP/1.1 101 Web Socket Protocol Handshake â‘ 
Connection: Upgrade â‘¡
Upgrade: websocket â‘¢
Sec-WebSocket-Accept: 52Rg3vW4JQ1yWpkvFlsTsiezlqw= â‘£
å¤åˆ¶ä»£ç </code></pre>
<blockquote>
<p>å¤‡æ³¨ï¼šå·²å¿½ç•¥éƒ¨åˆ† HTTP å“åº”å¤´</p>
</blockquote>
<ul>
<li>â‘  101 å“åº”ç ç¡®è®¤å‡çº§åˆ° WebSocket åè®®ã€‚</li>
<li>â‘¡ è®¾ç½® Connection å¤´çš„å€¼ä¸º â€œUpgradeâ€ æ¥æŒ‡ç¤ºè¿™æ˜¯ä¸€ä¸ªå‡çº§è¯·æ±‚ã€‚HTTP åè®®æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„æœºåˆ¶ï¼Œè¿™ä¸€æœºåˆ¶å…è®¸å°†ä¸€ä¸ªå·²å»ºç«‹çš„è¿æ¥å‡çº§æˆæ–°çš„ã€ä¸ç›¸å®¹çš„åè®®ã€‚</li>
<li>â‘¢ Upgrade å¤´æŒ‡å®šä¸€é¡¹æˆ–å¤šé¡¹åè®®åï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºï¼Œä»¥é€—å·åˆ†éš”ã€‚è¿™é‡Œè¡¨ç¤ºå‡çº§ä¸º WebSocket åè®®ã€‚</li>
<li>â‘£ ç­¾åçš„é”®å€¼éªŒè¯åè®®æ”¯æŒã€‚</li>
</ul>
<p>ä»‹ç»å®Œ WebSocket çš„æ¡æ‰‹åè®®ï¼Œæ¥ä¸‹æ¥é˜¿å®å“¥å°†ä½¿ç”¨ Node.js æ¥å¼€å‘æˆ‘ä»¬çš„ WebSocket æœåŠ¡å™¨ã€‚</p>
<h4 id="3-2-å®ç°æ¡æ‰‹åŠŸèƒ½"><a href="#3-2-å®ç°æ¡æ‰‹åŠŸèƒ½" class="headerlink" title="3.2 å®ç°æ¡æ‰‹åŠŸèƒ½"></a>3.2 å®ç°æ¡æ‰‹åŠŸèƒ½</h4><p>è¦å¼€å‘ä¸€ä¸ª WebSocket æœåŠ¡å™¨ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å…ˆå®ç°æ¡æ‰‹åŠŸèƒ½ï¼Œè¿™é‡Œé˜¿å®å“¥ä½¿ç”¨ Node.js å†…ç½®çš„ <strong>http</strong> æ¨¡å—æ¥åˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>const http = require("http");

const port = 8888;
const &amp;#123; generateAcceptValue &amp;#125; = require("./util");

const server = http.createServer((req, res) =&gt; &amp;#123;
  res.writeHead(200, &amp;#123; "Content-Type": "text/plain; charset=utf-8" &amp;#125;);
  res.end("å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯é˜¿å®å“¥ã€‚æ„Ÿè°¢ä½ é˜…è¯»â€œä½ ä¸çŸ¥é“çš„WebSocketâ€");
&amp;#125;);

server.on("upgrade", function (req, socket) &amp;#123;
  if (req.headers["upgrade"] !== "websocket") &amp;#123;
    socket.end("HTTP/1.1 400 Bad Request");
    return;
  &amp;#125;
  // è¯»å–å®¢æˆ·ç«¯æä¾›çš„Sec-WebSocket-Key
  const secWsKey = req.headers["sec-websocket-key"];
  // ä½¿ç”¨SHA-1ç®—æ³•ç”ŸæˆSec-WebSocket-Accept
  const hash = generateAcceptValue(secWsKey);
  // è®¾ç½®HTTPå“åº”å¤´
  const responseHeaders = [
    "HTTP/1.1 101 Web Socket Protocol Handshake",
    "Upgrade: WebSocket",
    "Connection: Upgrade",
    `Sec-WebSocket-Accept: $&amp;#123;hash&amp;#125;`,
  ];
  // è¿”å›æ¡æ‰‹è¯·æ±‚çš„å“åº”ä¿¡æ¯
  socket.write(responseHeaders.join("\r\n") + "\r\n\r\n");
&amp;#125;);

server.listen(port, () =&gt;
  console.log(`Server running at http://localhost:$&amp;#123;port&amp;#125;`)
);
å¤åˆ¶ä»£ç </code></pre>
<p>åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå¼•å…¥äº† <strong>http</strong> æ¨¡å—ï¼Œç„¶åé€šè¿‡è°ƒç”¨è¯¥æ¨¡å—çš„ <code>createServer()</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œæ¥ç€æˆ‘ä»¬ç›‘å¬ <code>upgrade</code> äº‹ä»¶ï¼Œæ¯æ¬¡æœåŠ¡å™¨å“åº”å‡çº§è¯·æ±‚æ—¶å°±ä¼šè§¦å‘è¯¥äº‹ä»¶ã€‚ç”±äºæˆ‘ä»¬çš„æœåŠ¡å™¨åªæ”¯æŒå‡çº§åˆ° WebSocket åè®®ï¼Œæ‰€ä»¥å¦‚æœå®¢æˆ·ç«¯è¯·æ±‚å‡çº§çš„åè®®é WebSocket åè®®ï¼Œæˆ‘ä»¬å°†ä¼šè¿”å› â€œ400 Bad Requestâ€ã€‚</p>
<p>å½“æœåŠ¡å™¨æ¥æ”¶åˆ°å‡çº§ä¸º WebSocket çš„æ¡æ‰‹è¯·æ±‚æ—¶ï¼Œä¼šå…ˆä»è¯·æ±‚å¤´ä¸­è·å– <strong>â€œSec-WebSocket-Keyâ€</strong> çš„å€¼ï¼Œç„¶åæŠŠè¯¥å€¼åŠ ä¸Šä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ä¸² <strong>â€œ258EAFA5-E914-47DA-95CA-C5AB0DC85B11â€</strong>ï¼Œç„¶åè®¡ç®— SHA-1 æ‘˜è¦ï¼Œä¹‹åè¿›è¡Œ Base64 ç¼–ç ï¼Œå°†ç»“æœåšä¸º <strong>â€œSec-WebSocket-Acceptâ€</strong> å¤´çš„å€¼ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>ä¸Šè¿°çš„è¿‡ç¨‹çœ‹èµ·æ¥å¥½åƒæœ‰ç‚¹ç¹çï¼Œå…¶å®åˆ©ç”¨ Node.js å†…ç½®çš„ <strong>crypto</strong> æ¨¡å—ï¼Œå‡ è¡Œä»£ç å°±å¯ä»¥æå®šäº†ï¼š</p>
<pre><code>// util.js
const crypto = require("crypto");
const MAGIC_KEY = "258EAFA5-E914-47DA-95CA-C5AB0DC85B11";

function generateAcceptValue(secWsKey) &amp;#123;
  return crypto
    .createHash("sha1")
    .update(secWsKey + MAGIC_KEY, "utf8")
    .digest("base64");
&amp;#125;
å¤åˆ¶ä»£ç </code></pre>
<p>å¼€å‘å®Œæ¡æ‰‹åŠŸèƒ½ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‰é¢çš„ç¤ºä¾‹æ¥æµ‹è¯•ä¸€ä¸‹è¯¥åŠŸèƒ½ã€‚å¾…æœåŠ¡å™¨å¯åŠ¨ä¹‹åï¼Œæˆ‘ä»¬åªè¦å¯¹ â€œå‘é€æ™®é€šæ–‡æœ¬â€ ç¤ºä¾‹ï¼Œåšç®€å•åœ°è°ƒæ•´ï¼Œå³æŠŠå…ˆå‰çš„ URL åœ°å€æ›¿æ¢æˆ <code>ws://localhost:8888</code>ï¼Œå°±å¯ä»¥è¿›è¡ŒåŠŸèƒ½éªŒè¯ã€‚</p>
<p>æ„Ÿå…´è¶£çš„å°ä¼™ä»¬å¯ä»¥è¯•è¯•çœ‹ï¼Œä»¥ä¸‹æ˜¯é˜¿å®å“¥æœ¬åœ°è¿è¡Œåçš„ç»“æœï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e19930d1e9d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>ä»ä¸Šå›¾å¯çŸ¥ï¼Œæˆ‘ä»¬å®ç°çš„æ¡æ‰‹åŠŸèƒ½å·²ç»å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚é‚£ä¹ˆæ¡æ‰‹æœ‰æ²¡æœ‰å¯èƒ½å¤±è´¥å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚æ¯”å¦‚ç½‘ç»œé—®é¢˜ã€æœåŠ¡å™¨å¼‚å¸¸æˆ– <strong>Sec-WebSocket-Accept</strong> çš„å€¼ä¸æ­£ç¡®ã€‚</p>
<p>ä¸‹é¢é˜¿å®å“¥ä¿®æ”¹ä¸€ä¸‹ <strong>â€œSec-WebSocket-Acceptâ€</strong> ç”Ÿæˆè§„åˆ™ï¼Œæ¯”å¦‚ä¿®æ”¹ <strong>MAGIC_KEY</strong> çš„å€¼ï¼Œç„¶åé‡æ–°éªŒè¯ä¸€ä¸‹æ¡æ‰‹åŠŸèƒ½ã€‚æ­¤æ—¶ï¼Œæµè§ˆå™¨çš„æ§åˆ¶å°ä¼šè¾“å‡ºä»¥ä¸‹å¼‚å¸¸ä¿¡æ¯ï¼š</p>
<pre><code>WebSocket connection to 'ws://localhost:8888/' failed: Error during WebSocket handshake: Incorrect 'Sec-WebSocket-Accept' header value
å¤åˆ¶ä»£ç </code></pre>
<p>å¦‚æœä½ çš„ WebSocket æœåŠ¡å™¨è¦æ”¯æŒå­åè®®çš„è¯ï¼Œä½ å¯ä»¥å‚è€ƒä»¥ä¸‹ä»£ç è¿›è¡Œå­åè®®çš„å¤„ç†ï¼Œé˜¿å®å“¥å°±ä¸ç»§ç»­å±•å¼€ä»‹ç»äº†ã€‚</p>
<pre><code>// ä»è¯·æ±‚å¤´ä¸­è¯»å–å­åè®®
const protocol = req.headers["sec-websocket-protocol"];
// å¦‚æœåŒ…å«å­åè®®ï¼Œåˆ™è§£æå­åè®®
const protocols = !protocol ? [] : protocol.split(",").map((s) =&gt; s.trim());

// ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä»…åˆ¤æ–­æ˜¯å¦å«æœ‰JSONå­åè®®
if (protocols.includes("json")) &amp;#123;
  responseHeaders.push(`Sec-WebSocket-Protocol: json`);
&amp;#125;
å¤åˆ¶ä»£ç </code></pre>
<p>å¥½çš„ï¼ŒWebSocket æ¡æ‰‹åè®®ç›¸å…³çš„å†…å®¹åŸºæœ¬å·²ç»ä»‹ç»å®Œäº†ã€‚ä¸‹ä¸€æ­¥æˆ‘ä»¬æ¥ä»‹ç»å¼€å‘æ¶ˆæ¯é€šä¿¡åŠŸèƒ½éœ€è¦äº†è§£çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚</p>
<h4 id="3-3-æ¶ˆæ¯é€šä¿¡åŸºç¡€"><a href="#3-3-æ¶ˆæ¯é€šä¿¡åŸºç¡€" class="headerlink" title="3.3 æ¶ˆæ¯é€šä¿¡åŸºç¡€"></a>3.3 æ¶ˆæ¯é€šä¿¡åŸºç¡€</h4><p>åœ¨ WebSocket åè®®ä¸­ï¼Œæ•°æ®æ˜¯é€šè¿‡ä¸€ç³»åˆ—æ•°æ®å¸§æ¥è¿›è¡Œä¼ è¾“çš„ã€‚ä¸ºäº†é¿å…ç”±äºç½‘ç»œä¸­ä»‹ï¼ˆä¾‹å¦‚ä¸€äº›æ‹¦æˆªä»£ç†ï¼‰æˆ–è€…ä¸€äº›å®‰å…¨é—®é¢˜ï¼Œå®¢æˆ·ç«¯å¿…é¡»åœ¨å®ƒå‘é€åˆ°æœåŠ¡å™¨çš„æ‰€æœ‰å¸§ä¸­æ·»åŠ æ©ç ã€‚æœåŠ¡ç«¯æ”¶åˆ°æ²¡æœ‰æ·»åŠ æ©ç çš„æ•°æ®å¸§ä»¥åï¼Œå¿…é¡»ç«‹å³å…³é—­è¿æ¥ã€‚</p>
<h5 id="3-3-1-æ•°æ®å¸§æ ¼å¼"><a href="#3-3-1-æ•°æ®å¸§æ ¼å¼" class="headerlink" title="3.3.1 æ•°æ®å¸§æ ¼å¼"></a>3.3.1 æ•°æ®å¸§æ ¼å¼</h5><p>è¦å®ç°æ¶ˆæ¯é€šä¿¡ï¼Œæˆ‘ä»¬å°±å¿…é¡»äº†è§£ WebSocket æ•°æ®å¸§çš„æ ¼å¼ï¼š</p>
<pre><code> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-------+-+-------------+-------------------------------+
|F|R|R|R| opcode|M| Payload len |    Extended payload length    |
|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
|N|V|V|V|       |S|             |   (if payload len==126/127)   |
| |1|2|3|       |K|             |                               |
+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
|     Extended payload length continued, if payload len == 127  |
+ - - - - - - - - - - - - - - - +-------------------------------+
|                               |Masking-key, if MASK set to 1  |
+-------------------------------+-------------------------------+
| Masking-key (continued)       |          Payload Data         |
+-------------------------------- - - - - - - - - - - - - - - - +
:                     Payload Data continued ...                :
+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
|                     Payload Data continued ...                |
+---------------------------------------------------------------+
å¤åˆ¶ä»£ç </code></pre>
<p>å¯èƒ½æœ‰ä¸€äº›å°ä¼™ä¼´çœ‹åˆ°ä¸Šé¢çš„å†…å®¹ä¹‹åï¼Œå°±å¼€å§‹æœ‰ç‚¹ â€œæ‡µé€¼â€ äº†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç»“åˆå®é™…çš„æ•°æ®å¸§æ¥è¿›ä¸€æ­¥åˆ†æä¸€ä¸‹ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e199a03ed41?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>åœ¨ä¸Šå›¾ä¸­ï¼Œé˜¿å®å“¥ç®€å•åˆ†æäº† â€œå‘é€æ™®é€šæ–‡æœ¬â€ ç¤ºä¾‹å¯¹åº”çš„æ•°æ®å¸§æ ¼å¼ã€‚è¿™é‡Œæˆ‘ä»¬æ¥è¿›ä¸€æ­¥ä»‹ç»ä¸€ä¸‹ Payload lengthï¼Œå› ä¸ºåœ¨åé¢å¼€å‘æ•°æ®è§£æåŠŸèƒ½çš„æ—¶å€™ï¼Œéœ€è¦ç”¨åˆ°è¯¥çŸ¥è¯†ç‚¹ã€‚</p>
<p>Payload length è¡¨ç¤ºä»¥å­—èŠ‚ä¸ºå•ä½çš„ â€œæœ‰æ•ˆè´Ÿè½½æ•°æ®â€ é•¿åº¦ã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ç§æƒ…å½¢ï¼š</p>
<ul>
<li>å¦‚æœå€¼ä¸º 0-125ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºè´Ÿè½½æ•°æ®çš„é•¿åº¦ã€‚</li>
<li>å¦‚æœæ˜¯ 126ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„ 2 ä¸ªå­—èŠ‚è§£é‡Šä¸º 16 ä½çš„æ— ç¬¦å·æ•´å½¢ä½œä¸ºè´Ÿè½½æ•°æ®çš„é•¿åº¦ã€‚</li>
<li>å¦‚æœæ˜¯ 127ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„ 8 ä¸ªå­—èŠ‚è§£é‡Šä¸ºä¸€ä¸ª 64 ä½çš„æ— ç¬¦å·æ•´å½¢ï¼ˆæœ€é«˜ä½çš„ bit å¿…é¡»ä¸º 0ï¼‰ä½œä¸ºè´Ÿè½½æ•°æ®çš„é•¿åº¦ã€‚</li>
</ul>
<p>å¤šå­—èŠ‚é•¿åº¦é‡ä»¥ç½‘ç»œå­—èŠ‚é¡ºåºè¡¨ç¤ºï¼Œæœ‰æ•ˆè´Ÿè½½é•¿åº¦æ˜¯æŒ‡ â€œæ‰©å±•æ•°æ®â€ + â€œåº”ç”¨æ•°æ®â€ çš„é•¿åº¦ã€‚â€œæ‰©å±•æ•°æ®â€ çš„é•¿åº¦å¯èƒ½ä¸º 0ï¼Œé‚£ä¹ˆæœ‰æ•ˆè´Ÿè½½é•¿åº¦å°±æ˜¯ â€œåº”ç”¨æ•°æ®â€ çš„é•¿åº¦ã€‚</p>
<p>å¦å¤–ï¼Œé™¤éåå•†è¿‡æ‰©å±•ï¼Œå¦åˆ™ â€œæ‰©å±•æ•°æ®â€ é•¿åº¦ä¸º 0 å­—èŠ‚ã€‚åœ¨æ¡æ‰‹åè®®ä¸­ï¼Œä»»ä½•æ‰©å±•éƒ½å¿…é¡»æŒ‡å®š â€œæ‰©å±•æ•°æ®â€ çš„é•¿åº¦ï¼Œè¿™ä¸ªé•¿åº¦å¦‚ä½•è¿›è¡Œè®¡ç®—ï¼Œä»¥åŠè¿™ä¸ªæ‰©å±•å¦‚ä½•ä½¿ç”¨ã€‚å¦‚æœå­˜åœ¨æ‰©å±•ï¼Œé‚£ä¹ˆè¿™ä¸ª â€œæ‰©å±•æ•°æ®â€ åŒ…å«åœ¨æ€»çš„æœ‰æ•ˆè´Ÿè½½é•¿åº¦ä¸­ã€‚</p>
<h5 id="3-3-2-æ©ç ç®—æ³•"><a href="#3-3-2-æ©ç ç®—æ³•" class="headerlink" title="3.3.2 æ©ç ç®—æ³•"></a>3.3.2 æ©ç ç®—æ³•</h5><p>æ©ç å­—æ®µæ˜¯ä¸€ä¸ªç”±å®¢æˆ·ç«¯éšæœºé€‰æ‹©çš„ 32 ä½çš„å€¼ã€‚æ©ç å€¼å¿…é¡»æ˜¯ä¸å¯è¢«é¢„æµ‹çš„ã€‚å› æ­¤ï¼Œæ©ç å¿…é¡»æ¥è‡ªå¼ºå¤§çš„ç†µæºï¼ˆentropyï¼‰ï¼Œå¹¶ä¸”ç»™å®šçš„æ©ç ä¸èƒ½è®©æœåŠ¡å™¨æˆ–è€…ä»£ç†èƒ½å¤Ÿå¾ˆå®¹æ˜“çš„é¢„æµ‹åˆ°åç»­å¸§ã€‚æ©ç çš„ä¸å¯é¢„æµ‹æ€§å¯¹äºé¢„é˜²æ¶æ„åº”ç”¨çš„ä½œè€…åœ¨ç½‘ä¸Šæš´éœ²ç›¸å…³çš„å­—èŠ‚æ•°æ®è‡³å…³é‡è¦ã€‚</p>
<p>æ©ç ä¸å½±å“æ•°æ®è·è½½çš„é•¿åº¦ï¼Œå¯¹æ•°æ®è¿›è¡Œæ©ç æ“ä½œå’Œå¯¹æ•°æ®è¿›è¡Œåæ©ç æ“ä½œæ‰€æ¶‰åŠçš„æ­¥éª¤æ˜¯ç›¸åŒçš„ã€‚æ©ç ã€åæ©ç æ“ä½œéƒ½é‡‡ç”¨å¦‚ä¸‹ç®—æ³•ï¼š</p>
<pre><code>j = i MOD 4
transformed-octet-i = original-octet-i XOR masking-key-octet-j
å¤åˆ¶ä»£ç </code></pre>
<ul>
<li>original-octet-iï¼šä¸ºåŸå§‹æ•°æ®çš„ç¬¬ i å­—èŠ‚ã€‚</li>
<li>transformed-octet-iï¼šä¸ºè½¬æ¢åçš„æ•°æ®çš„ç¬¬ i å­—èŠ‚ã€‚</li>
<li>masking-key-octet-jï¼šä¸º mask key ç¬¬ j å­—èŠ‚ã€‚</li>
</ul>
<p>ä¸ºäº†è®©å°ä¼™ä¼´ä»¬èƒ½å¤Ÿæ›´å¥½çš„ç†è§£ä¸Šé¢æ©ç çš„è®¡ç®—è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ¥å¯¹ç¤ºä¾‹ä¸­ <strong>â€œæˆ‘æ˜¯é˜¿å®å“¥â€</strong> æ•°æ®è¿›è¡Œæ©ç æ“ä½œã€‚è¿™é‡Œ <strong>â€œæˆ‘æ˜¯é˜¿å®å“¥â€</strong> å¯¹åº”çš„ UTF-8 ç¼–ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>E6 88 91 E6 98 AF E9 98 BF E5 AE 9D E5 93 A5
å¤åˆ¶ä»£ç </code></pre>
<p>è€Œå¯¹åº”çš„ Masking-Key ä¸º <code>0x08f6efb1</code>ï¼Œæ ¹æ®ä¸Šé¢çš„ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è¿›è¡Œæ©ç è¿ç®—ï¼š</p>
<pre><code>let uint8 = new Uint8Array([0xE6, 0x88, 0x91, 0xE6, 0x98, 0xAF, 0xE9, 0x98, 
  0xBF, 0xE5, 0xAE, 0x9D, 0xE5, 0x93, 0xA5]);
let maskingKey = new Uint8Array([0x08, 0xf6, 0xef, 0xb1]);
let maskedUint8 = new Uint8Array(uint8.length);

for (let i = 0, j = 0; i &lt; uint8.length; i++, j = i % 4) &amp;#123;
  maskedUint8[i] = uint8[i] ^ maskingKey[j];
&amp;#125;

console.log(Array.from(maskedUint8).map(num=&gt;Number(num).toString(16)).join(' '));
å¤åˆ¶ä»£ç </code></pre>
<p>ä»¥ä¸Šä»£ç æˆåŠŸè¿è¡Œåï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºä»¥ä¸‹ç»“æœï¼š</p>
<pre><code>ee 7e 7e 57 90 59 6 29 b7 13 41 2c ed 65 4a
å¤åˆ¶ä»£ç </code></pre>
<p>ä¸Šè¿°ç»“æœä¸ WireShark ä¸­çš„ Masked payload å¯¹åº”çš„å€¼æ˜¯ä¸€è‡´çš„ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e19aab98024?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>åœ¨ WebSocket åè®®ä¸­ï¼Œæ•°æ®æ©ç çš„ä½œç”¨æ˜¯å¢å¼ºåè®®çš„å®‰å…¨æ€§ã€‚ä½†æ•°æ®æ©ç å¹¶ä¸æ˜¯ä¸ºäº†ä¿æŠ¤æ•°æ®æœ¬èº«ï¼Œå› ä¸ºç®—æ³•æœ¬èº«æ˜¯å…¬å¼€çš„ï¼Œè¿ç®—ä¹Ÿä¸å¤æ‚ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜è¦å¼•å…¥æ•°æ®æ©ç å‘¢ï¼Ÿå¼•å…¥æ•°æ®æ©ç æ˜¯ä¸ºäº†é˜²æ­¢æ—©æœŸç‰ˆæœ¬çš„åè®®ä¸­å­˜åœ¨çš„ä»£ç†ç¼“å­˜æ±¡æŸ“æ”»å‡»ç­‰é—®é¢˜ã€‚</p>
<p>äº†è§£å®Œ WebSocket æ©ç ç®—æ³•å’Œæ•°æ®æ©ç çš„ä½œç”¨ä¹‹åï¼Œæˆ‘ä»¬å†æ¥ä»‹ç»ä¸€ä¸‹æ•°æ®åˆ†ç‰‡çš„æ¦‚å¿µã€‚</p>
<h5 id="3-3-3-æ•°æ®åˆ†ç‰‡"><a href="#3-3-3-æ•°æ®åˆ†ç‰‡" class="headerlink" title="3.3.3 æ•°æ®åˆ†ç‰‡"></a>3.3.3 æ•°æ®åˆ†ç‰‡</h5><p>WebSocket çš„æ¯æ¡æ¶ˆæ¯å¯èƒ½è¢«åˆ‡åˆ†æˆå¤šä¸ªæ•°æ®å¸§ã€‚å½“ WebSocket çš„æ¥æ”¶æ–¹æ”¶åˆ°ä¸€ä¸ªæ•°æ®å¸§æ—¶ï¼Œä¼šæ ¹æ® FIN çš„å€¼æ¥åˆ¤æ–­ï¼Œæ˜¯å¦å·²ç»æ”¶åˆ°æ¶ˆæ¯çš„æœ€åä¸€ä¸ªæ•°æ®å¸§ã€‚</p>
<p>åˆ©ç”¨ FIN å’Œ Opcodeï¼Œæˆ‘ä»¬å°±å¯ä»¥è·¨å¸§å‘é€æ¶ˆæ¯ã€‚æ“ä½œç å‘Šè¯‰äº†å¸§åº”è¯¥åšä»€ä¹ˆã€‚å¦‚æœæ˜¯ 0x1ï¼Œæœ‰æ•ˆè½½è·å°±æ˜¯æ–‡æœ¬ã€‚å¦‚æœæ˜¯ 0x2ï¼Œæœ‰æ•ˆè½½è·å°±æ˜¯äºŒè¿›åˆ¶æ•°æ®ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ˜¯ 0x0ï¼Œåˆ™è¯¥å¸§æ˜¯ä¸€ä¸ªå»¶ç»­å¸§ã€‚è¿™æ„å‘³ç€æœåŠ¡å™¨åº”è¯¥å°†å¸§çš„æœ‰æ•ˆè´Ÿè½½è¿æ¥åˆ°ä»è¯¥å®¢æˆ·æœºæ¥æ”¶åˆ°çš„æœ€åä¸€ä¸ªå¸§ã€‚</p>
<p>ä¸ºäº†è®©å¤§å®¶èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£ä¸Šè¿°çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ¥è‡ª <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSockets_API/Writing_WebSocket_servers">MDN</a> ä¸Šçš„ç¤ºä¾‹ï¼š</p>
<pre><code>Client: FIN=1, opcode=0x1, msg="hello"
Server: (process complete message immediately) Hi.
Client: FIN=0, opcode=0x1, msg="and a"
Server: (listening, new message containing text started)
Client: FIN=0, opcode=0x0, msg="happy new"
Server: (listening, payload concatenated to previous message)
Client: FIN=1, opcode=0x0, msg="year!"
Server: (process complete message) Happy new year to you too!
å¤åˆ¶ä»£ç </code></pre>
<p>åœ¨ä»¥ä¸Šç¤ºä¾‹ä¸­ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€äº†ä¸¤æ¡æ¶ˆæ¯ã€‚ç¬¬ä¸€ä¸ªæ¶ˆæ¯åœ¨å•ä¸ªå¸§ä¸­å‘é€ï¼Œè€Œç¬¬äºŒä¸ªæ¶ˆæ¯è·¨ä¸‰ä¸ªå¸§å‘é€ã€‚</p>
<p>å…¶ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼ˆFIN=1 ä¸” opcode != 0x0)ï¼Œå› æ­¤æœåŠ¡å™¨å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œå¤„ç†æˆ–å“åº”ã€‚è€Œç¬¬äºŒä¸ªæ¶ˆæ¯æ˜¯æ–‡æœ¬æ¶ˆæ¯ï¼ˆopcode=0x1ï¼‰ä¸” FIN=0ï¼Œè¡¨ç¤ºæ¶ˆæ¯è¿˜æ²¡å‘é€å®Œæˆï¼Œè¿˜æœ‰åç»­çš„æ•°æ®å¸§ã€‚è¯¥æ¶ˆæ¯çš„æ‰€æœ‰å‰©ä½™éƒ¨åˆ†éƒ½ç”¨å»¶ç»­å¸§ï¼ˆopcode=0x0ï¼‰å‘é€ï¼Œæ¶ˆæ¯çš„æœ€ç»ˆå¸§ç”¨ FIN=1 æ ‡è®°ã€‚</p>
<p>å¥½çš„ï¼Œç®€å•ä»‹ç»äº†æ•°æ®åˆ†ç‰‡çš„ç›¸å…³å†…å®¹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å¼€å§‹å®ç°æ¶ˆæ¯é€šä¿¡åŠŸèƒ½ã€‚</p>
<h4 id="3-4-å®ç°æ¶ˆæ¯é€šä¿¡åŠŸèƒ½"><a href="#3-4-å®ç°æ¶ˆæ¯é€šä¿¡åŠŸèƒ½" class="headerlink" title="3.4 å®ç°æ¶ˆæ¯é€šä¿¡åŠŸèƒ½"></a>3.4 å®ç°æ¶ˆæ¯é€šä¿¡åŠŸèƒ½</h4><p>é˜¿å®å“¥æŠŠå®ç°æ¶ˆæ¯é€šä¿¡åŠŸèƒ½ï¼Œåˆ†è§£ä¸ºæ¶ˆæ¯è§£æä¸æ¶ˆæ¯å“åº”ä¸¤ä¸ªå­åŠŸèƒ½ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥ä»‹ç»å¦‚ä½•å®ç°è¿™ä¸¤ä¸ªå­åŠŸèƒ½ã€‚</p>
<h5 id="3-4-1-æ¶ˆæ¯è§£æ"><a href="#3-4-1-æ¶ˆæ¯è§£æ" class="headerlink" title="3.4.1 æ¶ˆæ¯è§£æ"></a>3.4.1 æ¶ˆæ¯è§£æ</h5><p>åˆ©ç”¨æ¶ˆæ¯é€šä¿¡åŸºç¡€ç¯èŠ‚ä¸­ä»‹ç»çš„ç›¸å…³çŸ¥è¯†ï¼Œé˜¿å®å“¥å®ç°äº†ä¸€ä¸ª parseMessage å‡½æ•°ï¼Œç”¨æ¥è§£æå®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„ WebSocket æ•°æ®å¸§ã€‚å‡ºäºç®€å•è€ƒè™‘ï¼Œè¿™é‡Œåªå¤„ç†æ–‡æœ¬å¸§ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>function parseMessage(buffer) &amp;#123;
  // ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼ŒåŒ…å«äº†FINä½ï¼Œopcode, æ©ç ä½
  const firstByte = buffer.readUInt8(0);
  // [FIN, RSV, RSV, RSV, OPCODE, OPCODE, OPCODE, OPCODE];
  // å³ç§»7ä½å–é¦–ä½ï¼Œ1ä½ï¼Œè¡¨ç¤ºæ˜¯å¦æ˜¯æœ€åä¸€å¸§æ•°æ®
  const isFinalFrame = Boolean((firstByte &gt;&gt;&gt; 7) &amp; 0x01);
  console.log("isFIN: ", isFinalFrame);
  // å–å‡ºæ“ä½œç ï¼Œä½å››ä½
  /**
   * %x0ï¼šè¡¨ç¤ºä¸€ä¸ªå»¶ç»­å¸§ã€‚å½“ Opcode ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®ä¼ è¾“é‡‡ç”¨äº†æ•°æ®åˆ†ç‰‡ï¼Œå½“å‰æ”¶åˆ°çš„æ•°æ®å¸§ä¸ºå…¶ä¸­ä¸€ä¸ªæ•°æ®åˆ†ç‰‡ï¼›
   * %x1ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬å¸§ï¼ˆtext frameï¼‰ï¼›
   * %x2ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶å¸§ï¼ˆbinary frameï¼‰ï¼›
   * %x3-7ï¼šä¿ç•™çš„æ“ä½œä»£ç ï¼Œç”¨äºåç»­å®šä¹‰çš„éæ§åˆ¶å¸§ï¼›
   * %x8ï¼šè¡¨ç¤ºè¿æ¥æ–­å¼€ï¼›
   * %x9ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¿ƒè·³è¯·æ±‚ï¼ˆpingï¼‰ï¼›
   * %xAï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¿ƒè·³å“åº”ï¼ˆpongï¼‰ï¼›
   * %xB-Fï¼šä¿ç•™çš„æ“ä½œä»£ç ï¼Œç”¨äºåç»­å®šä¹‰çš„æ§åˆ¶å¸§ã€‚
   */
  const opcode = firstByte &amp; 0x0f;
  if (opcode === 0x08) &amp;#123;
    // è¿æ¥å…³é—­
    return;
  &amp;#125;
  if (opcode === 0x02) &amp;#123;
    // äºŒè¿›åˆ¶å¸§
    return;
  &amp;#125;
  if (opcode === 0x01) &amp;#123;
    // ç›®å‰åªå¤„ç†æ–‡æœ¬å¸§
    let offset = 1;
    const secondByte = buffer.readUInt8(offset);
    // MASK: 1ä½ï¼Œè¡¨ç¤ºæ˜¯å¦ä½¿ç”¨äº†æ©ç ï¼Œåœ¨å‘é€ç»™æœåŠ¡ç«¯çš„æ•°æ®å¸§é‡Œå¿…é¡»ä½¿ç”¨æ©ç ï¼Œè€ŒæœåŠ¡ç«¯è¿”å›æ—¶ä¸éœ€è¦æ©ç 
    const useMask = Boolean((secondByte &gt;&gt;&gt; 7) &amp; 0x01);
    console.log("use MASK: ", useMask);
    const payloadLen = secondByte &amp; 0x7f; // ä½7ä½è¡¨ç¤ºè½½è·å­—èŠ‚é•¿åº¦
    offset += 1;
    // å››ä¸ªå­—èŠ‚çš„æ©ç 
    let MASK = [];
    // å¦‚æœè¿™ä¸ªå€¼åœ¨0-125ä¹‹é—´ï¼Œåˆ™åé¢çš„4ä¸ªå­—èŠ‚ï¼ˆ32ä½ï¼‰å°±åº”è¯¥è¢«ç›´æ¥è¯†åˆ«æˆæ©ç ï¼›
    if (payloadLen &lt;= 0x7d) &amp;#123;
      // è½½è·é•¿åº¦å°äº125
      MASK = buffer.slice(offset, 4 + offset);
      offset += 4;
      console.log("payload length: ", payloadLen);
    &amp;#125; else if (payloadLen === 0x7e) &amp;#123;
      // å¦‚æœè¿™ä¸ªå€¼æ˜¯126ï¼Œåˆ™åé¢ä¸¤ä¸ªå­—èŠ‚ï¼ˆ16ä½ï¼‰å†…å®¹åº”è¯¥ï¼Œè¢«è¯†åˆ«æˆä¸€ä¸ª16ä½çš„äºŒè¿›åˆ¶æ•°è¡¨ç¤ºæ•°æ®å†…å®¹å¤§å°ï¼›
      console.log("payload length: ", buffer.readInt16BE(offset));
      // é•¿åº¦æ˜¯126ï¼Œ åˆ™åé¢ä¸¤ä¸ªå­—èŠ‚ä½œä¸ºpayload lengthï¼Œ32ä½çš„æ©ç 
      MASK = buffer.slice(offset + 2, offset + 2 + 4);
      offset += 6;
    &amp;#125; else &amp;#123;
      // å¦‚æœè¿™ä¸ªå€¼æ˜¯127ï¼Œåˆ™åé¢çš„8ä¸ªå­—èŠ‚ï¼ˆ64ä½ï¼‰å†…å®¹åº”è¯¥è¢«è¯†åˆ«æˆä¸€ä¸ª64ä½çš„äºŒè¿›åˆ¶æ•°è¡¨ç¤ºæ•°æ®å†…å®¹å¤§å°
      MASK = buffer.slice(offset + 8, offset + 8 + 4);
      offset += 12;
    &amp;#125;
    // å¼€å§‹è¯»å–åé¢çš„payloadï¼Œä¸æ©ç è®¡ç®—ï¼Œå¾—åˆ°åŸæ¥çš„å­—èŠ‚å†…å®¹
    const newBuffer = [];
    const dataBuffer = buffer.slice(offset);
    for (let i = 0, j = 0; i &lt; dataBuffer.length; i++, j = i % 4) &amp;#123;
      const nextBuf = dataBuffer[i];
      newBuffer.push(nextBuf ^ MASK[j]);
    &amp;#125;
    return Buffer.from(newBuffer).toString();
  &amp;#125;
  return "";
&amp;#125;
å¤åˆ¶ä»£ç </code></pre>
<p>åˆ›å»ºå®Œ parseMessage å‡½æ•°ï¼Œæˆ‘ä»¬æ¥æ›´æ–°ä¸€ä¸‹ä¹‹å‰åˆ›å»ºçš„ WebSocket æœåŠ¡å™¨ï¼š</p>
<pre><code>server.on("upgrade", function (req, socket) &amp;#123;
  socket.on("data", (buffer) =&gt; &amp;#123;
    const message = parseMessage(buffer);
    if (message) &amp;#123;
      console.log("Message from client:" + message);
    &amp;#125; else if (message === null) &amp;#123;
      console.log("WebSocket connection closed by the client.");
    &amp;#125;
  &amp;#125;);
  if (req.headers["upgrade"] !== "websocket") &amp;#123;
    socket.end("HTTP/1.1 400 Bad Request");
    return;
  &amp;#125;
  // çœç•¥å·²æœ‰ä»£ç 
&amp;#125;);
å¤åˆ¶ä»£ç </code></pre>
<p>æ›´æ–°å®Œæˆä¹‹åï¼Œæˆ‘ä»¬é‡æ–°å¯åŠ¨æœåŠ¡å™¨ï¼Œç„¶åç»§ç»­ä½¿ç”¨ â€œå‘é€æ™®é€šæ–‡æœ¬â€ çš„ç¤ºä¾‹æ¥æµ‹è¯•æ¶ˆæ¯è§£æåŠŸèƒ½ã€‚ä»¥ä¸‹å‘é€ â€œæˆ‘æ˜¯é˜¿å®å“¥â€ æ–‡æœ¬æ¶ˆæ¯åï¼ŒWebSocket æœåŠ¡å™¨è¾“å‡ºçš„ä¿¡æ¯ã€‚</p>
<pre><code>Server running at http://localhost:8888
isFIN:  true
use MASK:  true
payload length:  15
Message from client:æˆ‘æ˜¯é˜¿å®å“¥
å¤åˆ¶ä»£ç </code></pre>
<p>é€šè¿‡è§‚å¯Ÿä»¥ä¸Šçš„è¾“å‡ºä¿¡æ¯ï¼Œæˆ‘ä»¬çš„ WebSocket æœåŠ¡å™¨å·²ç»å¯ä»¥æˆåŠŸè§£æå®¢æˆ·ç«¯å‘é€åŒ…å«æ™®é€šæ–‡æœ¬çš„æ•°æ®å¸§ï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬æ¥å®ç°æ¶ˆæ¯å“åº”çš„åŠŸèƒ½ã€‚</p>
<h5 id="3-4-2-æ¶ˆæ¯å“åº”"><a href="#3-4-2-æ¶ˆæ¯å“åº”" class="headerlink" title="3.4.2 æ¶ˆæ¯å“åº”"></a>3.4.2 æ¶ˆæ¯å“åº”</h5><p>è¦æŠŠæ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬çš„ WebSocket æœåŠ¡å™¨ä¹Ÿå¾—æŒ‰ç…§ WebSocket æ•°æ®å¸§çš„æ ¼å¼æ¥å°è£…æ•°æ®ã€‚ä¸å‰é¢ä»‹ç»çš„ parseMessage å‡½æ•°ä¸€æ ·ï¼Œé˜¿å®å“¥ä¹Ÿå°è£…äº†ä¸€ä¸ª constructReply å‡½æ•°ç”¨æ¥å°è£…è¿”å›çš„æ•°æ®ï¼Œè¯¥å‡½æ•°çš„å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>function constructReply(data) &amp;#123;
  const json = JSON.stringify(data);
  const jsonByteLength = Buffer.byteLength(json);
  // ç›®å‰åªæ”¯æŒå°äº65535å­—èŠ‚çš„è´Ÿè½½
  const lengthByteCount = jsonByteLength &lt; 126 ? 0 : 2;
  const payloadLength = lengthByteCount === 0 ? jsonByteLength : 126;
  const buffer = Buffer.alloc(2 + lengthByteCount + jsonByteLength);
  // è®¾ç½®æ•°æ®å¸§é¦–å­—èŠ‚ï¼Œè®¾ç½®opcodeä¸º1ï¼Œè¡¨ç¤ºæ–‡æœ¬å¸§
  buffer.writeUInt8(0b10000001, 0);
  buffer.writeUInt8(payloadLength, 1);
  // å¦‚æœpayloadLengthä¸º126ï¼Œåˆ™åé¢ä¸¤ä¸ªå­—èŠ‚ï¼ˆ16ä½ï¼‰å†…å®¹åº”è¯¥ï¼Œè¢«è¯†åˆ«æˆä¸€ä¸ª16ä½çš„äºŒè¿›åˆ¶æ•°è¡¨ç¤ºæ•°æ®å†…å®¹å¤§å°
  let payloadOffset = 2;
  if (lengthByteCount &gt; 0) &amp;#123;
    buffer.writeUInt16BE(jsonByteLength, 2);
    payloadOffset += lengthByteCount;
  &amp;#125;
  // æŠŠJSONæ•°æ®å†™å…¥åˆ°Bufferç¼“å†²åŒºä¸­
  buffer.write(json, payloadOffset);
  return buffer;
&amp;#125;
å¤åˆ¶ä»£ç </code></pre>
<p>åˆ›å»ºå®Œ constructReply å‡½æ•°ï¼Œæˆ‘ä»¬å†æ¥æ›´æ–°ä¸€ä¸‹ä¹‹å‰åˆ›å»ºçš„ WebSocket æœåŠ¡å™¨ï¼š</p>
<pre><code>server.on("upgrade", function (req, socket) &amp;#123;
  socket.on("data", (buffer) =&gt; &amp;#123;
    const message = parseMessage(buffer);
    if (message) &amp;#123;
      console.log("Message from client:" + message);
      // æ–°å¢ä»¥ä¸‹ğŸ‘‡ä»£ç 
      socket.write(constructReply(&amp;#123; message &amp;#125;));
    &amp;#125; else if (message === null) &amp;#123;
      console.log("WebSocket connection closed by the client.");
    &amp;#125;
  &amp;#125;);
&amp;#125;);
å¤åˆ¶ä»£ç </code></pre>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„ WebSocket æœåŠ¡å™¨å·²ç»å¼€å‘å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®Œæ•´éªŒè¯ä¸€ä¸‹å®ƒçš„åŠŸèƒ½ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e19b333840e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>ä»å›¾ä¸­å¯çŸ¥ï¼Œæˆ‘ä»¬çš„å¼€å‘çš„ç®€æ˜“ç‰ˆ WebSocket æœåŠ¡å™¨å·²ç»å¯ä»¥æ­£å¸¸å¤„ç†æ™®é€šæ–‡æœ¬æ¶ˆæ¯äº†ã€‚æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®Œæ•´çš„ä»£ç ï¼š</p>
<p><strong>custom-websocket-server.js</strong></p>
<pre><code>const http = require("http");

const port = 8888;
const &amp;#123; generateAcceptValue, parseMessage, constructReply &amp;#125; = require("./util");

const server = http.createServer((req, res) =&gt; &amp;#123;
  res.writeHead(200, &amp;#123; "Content-Type": "text/plain; charset=utf-8" &amp;#125;);
  res.end("å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯é˜¿å®å“¥ã€‚æ„Ÿè°¢ä½ é˜…è¯»â€œä½ ä¸çŸ¥é“çš„WebSocketâ€");
&amp;#125;);

server.on("upgrade", function (req, socket) &amp;#123;
  socket.on("data", (buffer) =&gt; &amp;#123;
    const message = parseMessage(buffer);
    if (message) &amp;#123;
      console.log("Message from client:" + message);
      socket.write(constructReply(&amp;#123; message &amp;#125;));
    &amp;#125; else if (message === null) &amp;#123;
      console.log("WebSocket connection closed by the client.");
    &amp;#125;
  &amp;#125;);
  if (req.headers["upgrade"] !== "websocket") &amp;#123;
    socket.end("HTTP/1.1 400 Bad Request");
    return;
  &amp;#125;
  // è¯»å–å®¢æˆ·ç«¯æä¾›çš„Sec-WebSocket-Key
  const secWsKey = req.headers["sec-websocket-key"];
  // ä½¿ç”¨SHA-1ç®—æ³•ç”ŸæˆSec-WebSocket-Accept
  const hash = generateAcceptValue(secWsKey);
  // è®¾ç½®HTTPå“åº”å¤´
  const responseHeaders = [
    "HTTP/1.1 101 Web Socket Protocol Handshake",
    "Upgrade: WebSocket",
    "Connection: Upgrade",
    `Sec-WebSocket-Accept: $&amp;#123;hash&amp;#125;`,
  ];
  // è¿”å›æ¡æ‰‹è¯·æ±‚çš„å“åº”ä¿¡æ¯
  socket.write(responseHeaders.join("\r\n") + "\r\n\r\n");
&amp;#125;);

server.listen(port, () =&gt;
  console.log(`Server running at http://localhost:$&amp;#123;port&amp;#125;`)
);
å¤åˆ¶ä»£ç </code></pre>
<p><strong>util.js</strong></p>
<pre><code>const crypto = require("crypto");

const MAGIC_KEY = "258EAFA5-E914-47DA-95CA-C5AB0DC85B11";

function generateAcceptValue(secWsKey) &amp;#123;
  return crypto
    .createHash("sha1")
    .update(secWsKey + MAGIC_KEY, "utf8")
    .digest("base64");
&amp;#125;

function parseMessage(buffer) &amp;#123;
  // ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼ŒåŒ…å«äº†FINä½ï¼Œopcode, æ©ç ä½
  const firstByte = buffer.readUInt8(0);
  // [FIN, RSV, RSV, RSV, OPCODE, OPCODE, OPCODE, OPCODE];
  // å³ç§»7ä½å–é¦–ä½ï¼Œ1ä½ï¼Œè¡¨ç¤ºæ˜¯å¦æ˜¯æœ€åä¸€å¸§æ•°æ®
  const isFinalFrame = Boolean((firstByte &gt;&gt;&gt; 7) &amp; 0x01);
  console.log("isFIN: ", isFinalFrame);
  // å–å‡ºæ“ä½œç ï¼Œä½å››ä½
  /**
   * %x0ï¼šè¡¨ç¤ºä¸€ä¸ªå»¶ç»­å¸§ã€‚å½“ Opcode ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®ä¼ è¾“é‡‡ç”¨äº†æ•°æ®åˆ†ç‰‡ï¼Œå½“å‰æ”¶åˆ°çš„æ•°æ®å¸§ä¸ºå…¶ä¸­ä¸€ä¸ªæ•°æ®åˆ†ç‰‡ï¼›
   * %x1ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬å¸§ï¼ˆtext frameï¼‰ï¼›
   * %x2ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶å¸§ï¼ˆbinary frameï¼‰ï¼›
   * %x3-7ï¼šä¿ç•™çš„æ“ä½œä»£ç ï¼Œç”¨äºåç»­å®šä¹‰çš„éæ§åˆ¶å¸§ï¼›
   * %x8ï¼šè¡¨ç¤ºè¿æ¥æ–­å¼€ï¼›
   * %x9ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¿ƒè·³è¯·æ±‚ï¼ˆpingï¼‰ï¼›
   * %xAï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¿ƒè·³å“åº”ï¼ˆpongï¼‰ï¼›
   * %xB-Fï¼šä¿ç•™çš„æ“ä½œä»£ç ï¼Œç”¨äºåç»­å®šä¹‰çš„æ§åˆ¶å¸§ã€‚
   */
  const opcode = firstByte &amp; 0x0f;
  if (opcode === 0x08) &amp;#123;
    // è¿æ¥å…³é—­
    return;
  &amp;#125;
  if (opcode === 0x02) &amp;#123;
    // äºŒè¿›åˆ¶å¸§
    return;
  &amp;#125;
  if (opcode === 0x01) &amp;#123;
    // ç›®å‰åªå¤„ç†æ–‡æœ¬å¸§
    let offset = 1;
    const secondByte = buffer.readUInt8(offset);
    // MASK: 1ä½ï¼Œè¡¨ç¤ºæ˜¯å¦ä½¿ç”¨äº†æ©ç ï¼Œåœ¨å‘é€ç»™æœåŠ¡ç«¯çš„æ•°æ®å¸§é‡Œå¿…é¡»ä½¿ç”¨æ©ç ï¼Œè€ŒæœåŠ¡ç«¯è¿”å›æ—¶ä¸éœ€è¦æ©ç 
    const useMask = Boolean((secondByte &gt;&gt;&gt; 7) &amp; 0x01);
    console.log("use MASK: ", useMask);
    const payloadLen = secondByte &amp; 0x7f; // ä½7ä½è¡¨ç¤ºè½½è·å­—èŠ‚é•¿åº¦
    offset += 1;
    // å››ä¸ªå­—èŠ‚çš„æ©ç 
    let MASK = [];
    // å¦‚æœè¿™ä¸ªå€¼åœ¨0-125ä¹‹é—´ï¼Œåˆ™åé¢çš„4ä¸ªå­—èŠ‚ï¼ˆ32ä½ï¼‰å°±åº”è¯¥è¢«ç›´æ¥è¯†åˆ«æˆæ©ç ï¼›
    if (payloadLen &lt;= 0x7d) &amp;#123;
      // è½½è·é•¿åº¦å°äº125
      MASK = buffer.slice(offset, 4 + offset);
      offset += 4;
      console.log("payload length: ", payloadLen);
    &amp;#125; else if (payloadLen === 0x7e) &amp;#123;
      // å¦‚æœè¿™ä¸ªå€¼æ˜¯126ï¼Œåˆ™åé¢ä¸¤ä¸ªå­—èŠ‚ï¼ˆ16ä½ï¼‰å†…å®¹åº”è¯¥ï¼Œè¢«è¯†åˆ«æˆä¸€ä¸ª16ä½çš„äºŒè¿›åˆ¶æ•°è¡¨ç¤ºæ•°æ®å†…å®¹å¤§å°ï¼›
      console.log("payload length: ", buffer.readInt16BE(offset));
      // é•¿åº¦æ˜¯126ï¼Œ åˆ™åé¢ä¸¤ä¸ªå­—èŠ‚ä½œä¸ºpayload lengthï¼Œ32ä½çš„æ©ç 
      MASK = buffer.slice(offset + 2, offset + 2 + 4);
      offset += 6;
    &amp;#125; else &amp;#123;
      // å¦‚æœè¿™ä¸ªå€¼æ˜¯127ï¼Œåˆ™åé¢çš„8ä¸ªå­—èŠ‚ï¼ˆ64ä½ï¼‰å†…å®¹åº”è¯¥è¢«è¯†åˆ«æˆä¸€ä¸ª64ä½çš„äºŒè¿›åˆ¶æ•°è¡¨ç¤ºæ•°æ®å†…å®¹å¤§å°
      MASK = buffer.slice(offset + 8, offset + 8 + 4);
      offset += 12;
    &amp;#125;
    // å¼€å§‹è¯»å–åé¢çš„payloadï¼Œä¸æ©ç è®¡ç®—ï¼Œå¾—åˆ°åŸæ¥çš„å­—èŠ‚å†…å®¹
    const newBuffer = [];
    const dataBuffer = buffer.slice(offset);
    for (let i = 0, j = 0; i &lt; dataBuffer.length; i++, j = i % 4) &amp;#123;
      const nextBuf = dataBuffer[i];
      newBuffer.push(nextBuf ^ MASK[j]);
    &amp;#125;
    return Buffer.from(newBuffer).toString();
  &amp;#125;
  return "";
&amp;#125;

function constructReply(data) &amp;#123;
  const json = JSON.stringify(data);
  const jsonByteLength = Buffer.byteLength(json);
  // ç›®å‰åªæ”¯æŒå°äº65535å­—èŠ‚çš„è´Ÿè½½
  const lengthByteCount = jsonByteLength &lt; 126 ? 0 : 2;
  const payloadLength = lengthByteCount === 0 ? jsonByteLength : 126;
  const buffer = Buffer.alloc(2 + lengthByteCount + jsonByteLength);
  // è®¾ç½®æ•°æ®å¸§é¦–å­—èŠ‚ï¼Œè®¾ç½®opcodeä¸º1ï¼Œè¡¨ç¤ºæ–‡æœ¬å¸§
  buffer.writeUInt8(0b10000001, 0);
  buffer.writeUInt8(payloadLength, 1);
  // å¦‚æœpayloadLengthä¸º126ï¼Œåˆ™åé¢ä¸¤ä¸ªå­—èŠ‚ï¼ˆ16ä½ï¼‰å†…å®¹åº”è¯¥ï¼Œè¢«è¯†åˆ«æˆä¸€ä¸ª16ä½çš„äºŒè¿›åˆ¶æ•°è¡¨ç¤ºæ•°æ®å†…å®¹å¤§å°
  let payloadOffset = 2;
  if (lengthByteCount &gt; 0) &amp;#123;
    buffer.writeUInt16BE(jsonByteLength, 2);
    payloadOffset += lengthByteCount;
  &amp;#125;
  // æŠŠJSONæ•°æ®å†™å…¥åˆ°Bufferç¼“å†²åŒºä¸­
  buffer.write(json, payloadOffset);
  return buffer;
&amp;#125;

module.exports = &amp;#123;
  generateAcceptValue,
  parseMessage,
  constructReply,
&amp;#125;;
å¤åˆ¶ä»£ç </code></pre>
<p>å…¶å®æœåŠ¡å™¨å‘æµè§ˆå™¨æ¨é€ä¿¡æ¯ï¼Œé™¤äº†ä½¿ç”¨ WebSocket æŠ€æœ¯ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ SSEï¼ˆServer-Sent Eventsï¼‰ã€‚å®ƒè®©æœåŠ¡å™¨å¯ä»¥å‘å®¢æˆ·ç«¯æµå¼å‘é€æ–‡æœ¬æ¶ˆæ¯ï¼Œæ¯”å¦‚æœåŠ¡å™¨ä¸Šç”Ÿæˆçš„å®æ—¶æ¶ˆæ¯ã€‚ä¸ºå®ç°è¿™ä¸ªç›®æ ‡ï¼ŒSSE è®¾è®¡äº†ä¸¤ä¸ªç»„ä»¶ï¼š<strong>æµè§ˆå™¨ä¸­çš„ <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Server-sent_events/EventSource">EventSource API</a> å’Œæ–°çš„ â€œäº‹ä»¶æµâ€ æ•°æ®æ ¼å¼ï¼ˆtext/event-streamï¼‰</strong>ã€‚å…¶ä¸­ï¼ŒEventSource å¯ä»¥è®©å®¢æˆ·ç«¯ä»¥ DOM äº‹ä»¶çš„å½¢å¼æ¥æ”¶åˆ°æœåŠ¡å™¨æ¨é€çš„é€šçŸ¥ï¼Œè€Œæ–°æ•°æ®æ ¼å¼åˆ™ç”¨äºäº¤ä»˜æ¯ä¸€æ¬¡æ•°æ®æ›´æ–°ã€‚</p>
<p>å®é™…ä¸Šï¼ŒSSE æä¾›çš„æ˜¯ä¸€ä¸ªé«˜æ•ˆã€è·¨æµè§ˆå™¨çš„ XHR æµå®ç°ï¼Œæ¶ˆæ¯äº¤ä»˜åªä½¿ç”¨ä¸€ä¸ªé•¿ HTTP è¿æ¥ã€‚ç„¶è€Œï¼Œä¸æˆ‘ä»¬è‡ªå·±å®ç° XHR æµä¸åŒï¼Œæµè§ˆå™¨ä¼šå¸®æˆ‘ä»¬ç®¡ç†è¿æ¥ã€ è§£ææ¶ˆæ¯ï¼Œä»è€Œè®©æˆ‘ä»¬åªå…³æ³¨ä¸šåŠ¡é€»è¾‘ã€‚ç¯‡å¹…æœ‰é™ï¼Œå…³äº SSE çš„æ›´å¤šç»†èŠ‚ï¼Œé˜¿å®å“¥å°±ä¸å±•å¼€ä»‹ç»äº†ï¼Œå¯¹ SSE æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ç›¸å…³èµ„æ–™ã€‚</p>
<h3 id="å››ã€é˜¿å®å“¥æœ‰è¯è¯´"><a href="#å››ã€é˜¿å®å“¥æœ‰è¯è¯´" class="headerlink" title="å››ã€é˜¿å®å“¥æœ‰è¯è¯´"></a>å››ã€é˜¿å®å“¥æœ‰è¯è¯´</h3><h4 id="4-1-WebSocket-ä¸-HTTP-æœ‰ä»€ä¹ˆå…³ç³»"><a href="#4-1-WebSocket-ä¸-HTTP-æœ‰ä»€ä¹ˆå…³ç³»" class="headerlink" title="4.1 WebSocket ä¸ HTTP æœ‰ä»€ä¹ˆå…³ç³»"></a>4.1 WebSocket ä¸ HTTP æœ‰ä»€ä¹ˆå…³ç³»</h4><p>WebSocket æ˜¯ä¸€ç§ä¸ HTTP ä¸åŒçš„åè®®ã€‚ä¸¤è€…éƒ½ä½äº OSI æ¨¡å‹çš„åº”ç”¨å±‚ï¼Œå¹¶ä¸”éƒ½ä¾èµ–äºä¼ è¾“å±‚çš„ TCP åè®®ã€‚ è™½ç„¶å®ƒä»¬ä¸åŒï¼Œä½†æ˜¯ RFC 6455 ä¸­è§„å®šï¼šWebSocket è¢«è®¾è®¡ä¸ºåœ¨ HTTP 80 å’Œ 443 ç«¯å£ä¸Šå·¥ä½œï¼Œå¹¶æ”¯æŒ HTTP ä»£ç†å’Œä¸­ä»‹ï¼Œä»è€Œä½¿å…¶ä¸ HTTP åè®®å…¼å®¹ã€‚ ä¸ºäº†å®ç°å…¼å®¹æ€§ï¼ŒWebSocket æ¡æ‰‹ä½¿ç”¨ HTTP Upgrade å¤´ï¼Œä» HTTP åè®®æ›´æ”¹ä¸º WebSocket åè®®ã€‚</p>
<p>æ—¢ç„¶å·²ç»æåˆ°äº† <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">OSIï¼ˆOpen System Interconnection Modelï¼‰æ¨¡å‹</a>ï¼Œè¿™é‡Œé˜¿å®å“¥æ¥åˆ†äº«ä¸€å¼ å¾ˆç”ŸåŠ¨ã€å¾ˆå½¢è±¡æè¿° OSI æ¨¡å‹çš„ç¤ºæ„å›¾ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e19b626b49b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p>ï¼ˆå›¾ç‰‡æ¥æºï¼š<a target="_blank" rel="noopener" href="https://www.networkingsphere.com/2019/07/what-is-osi-model.html%EF%BC%89">https://www.networkingsphere.com/2019/07/what-is-osi-model.htmlï¼‰</a></p>
<h4 id="4-2-WebSocket-ä¸é•¿è½®è¯¢æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#4-2-WebSocket-ä¸é•¿è½®è¯¢æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="4.2 WebSocket ä¸é•¿è½®è¯¢æœ‰ä»€ä¹ˆåŒºåˆ«"></a>4.2 WebSocket ä¸é•¿è½®è¯¢æœ‰ä»€ä¹ˆåŒºåˆ«</h4><p>é•¿è½®è¯¢å°±æ˜¯å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚åï¼ŒæœåŠ¡å™¨ç«¯ä¸ä¼šç›´æ¥è¿›è¡Œå“åº”ï¼Œè€Œæ˜¯å…ˆå°†è¿™ä¸ªè¯·æ±‚æŒ‚èµ·ï¼Œç„¶ååˆ¤æ–­è¯·æ±‚çš„æ•°æ®æ˜¯å¦æœ‰æ›´æ–°ã€‚å¦‚æœæœ‰æ›´æ–°ï¼Œåˆ™è¿›è¡Œå“åº”ï¼Œå¦‚æœä¸€ç›´æ²¡æœ‰æ•°æ®ï¼Œåˆ™ç­‰å¾…ä¸€å®šçš„æ—¶é—´åæ‰è¿”å›ã€‚</p>
<p>é•¿è½®è¯¢çš„æœ¬è´¨è¿˜æ˜¯åŸºäº HTTP åè®®ï¼Œå®ƒä»ç„¶æ˜¯ä¸€ä¸ªä¸€é—®ä¸€ç­”ï¼ˆè¯·æ±‚ â€” å“åº”ï¼‰çš„æ¨¡å¼ã€‚è€Œ WebSocket åœ¨æ¡æ‰‹æˆåŠŸåï¼Œå°±æ˜¯å…¨åŒå·¥çš„ TCP é€šé“ï¼Œæ•°æ®å¯ä»¥ä¸»åŠ¨ä»æœåŠ¡ç«¯å‘é€åˆ°å®¢æˆ·ç«¯ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/27/17390e19c4b15f3a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<h4 id="4-3-ä»€ä¹ˆæ˜¯-WebSocket-å¿ƒè·³"><a href="#4-3-ä»€ä¹ˆæ˜¯-WebSocket-å¿ƒè·³" class="headerlink" title="4.3 ä»€ä¹ˆæ˜¯ WebSocket å¿ƒè·³"></a>4.3 ä»€ä¹ˆæ˜¯ WebSocket å¿ƒè·³</h4><p>ç½‘ç»œä¸­çš„æ¥æ”¶å’Œå‘é€æ•°æ®éƒ½æ˜¯ä½¿ç”¨ SOCKET è¿›è¡Œå®ç°ã€‚ä½†æ˜¯å¦‚æœæ­¤å¥—æ¥å­—å·²ç»æ–­å¼€ï¼Œé‚£å‘é€æ•°æ®å’Œæ¥æ”¶æ•°æ®çš„æ—¶å€™å°±ä¸€å®šä¼šæœ‰é—®é¢˜ã€‚å¯æ˜¯å¦‚ä½•åˆ¤æ–­è¿™ä¸ªå¥—æ¥å­—æ˜¯å¦è¿˜å¯ä»¥ä½¿ç”¨å‘¢ï¼Ÿè¿™ä¸ªå°±éœ€è¦åœ¨ç³»ç»Ÿä¸­åˆ›å»ºå¿ƒè·³æœºåˆ¶ã€‚æ‰€è°“ â€œå¿ƒè·³â€ å°±æ˜¯å®šæ—¶å‘é€ä¸€ä¸ªè‡ªå®šä¹‰çš„ç»“æ„ä½“ï¼ˆå¿ƒè·³åŒ…æˆ–å¿ƒè·³å¸§ï¼‰ï¼Œè®©å¯¹æ–¹çŸ¥é“è‡ªå·± â€œåœ¨çº¿â€ã€‚ ä»¥ç¡®ä¿é“¾æ¥çš„æœ‰æ•ˆæ€§ã€‚</p>
<p>è€Œæ‰€è°“çš„å¿ƒè·³åŒ…å°±æ˜¯å®¢æˆ·ç«¯å®šæ—¶å‘é€ç®€å•çš„ä¿¡æ¯ç»™æœåŠ¡å™¨ç«¯å‘Šè¯‰å®ƒæˆ‘è¿˜åœ¨è€Œå·²ã€‚ä»£ç å°±æ˜¯æ¯éš”å‡ åˆ†é’Ÿå‘é€ä¸€ä¸ªå›ºå®šä¿¡æ¯ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°åå›å¤ä¸€ä¸ªå›ºå®šä¿¡æ¯ï¼Œå¦‚æœæœåŠ¡ç«¯å‡ åˆ†é’Ÿå†…æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯ä¿¡æ¯åˆ™è§†å®¢æˆ·ç«¯æ–­å¼€ã€‚</p>
<p>åœ¨ WebSocket åè®®ä¸­å®šä¹‰äº† <strong>å¿ƒè·³ Ping</strong> å’Œ <strong>å¿ƒè·³ Pong</strong> çš„æ§åˆ¶å¸§ï¼š</p>
<ul>
<li>å¿ƒè·³ Ping å¸§åŒ…å«çš„æ“ä½œç æ˜¯ 0x9ã€‚å¦‚æœæ”¶åˆ°äº†ä¸€ä¸ªå¿ƒè·³ Ping å¸§ï¼Œé‚£ä¹ˆç»ˆç«¯å¿…é¡»å‘é€ä¸€ä¸ªå¿ƒè·³ Pong å¸§ä½œä¸ºå›åº”ï¼Œé™¤éå·²ç»æ”¶åˆ°äº†ä¸€ä¸ªå…³é—­å¸§ã€‚å¦åˆ™ç»ˆç«¯åº”è¯¥å°½å¿«å›å¤ Pong å¸§ã€‚</li>
<li>å¿ƒè·³ Pong å¸§åŒ…å«çš„æ“ä½œç æ˜¯ 0xAã€‚ä½œä¸ºå›åº”å‘é€çš„ Pong å¸§å¿…é¡»å®Œæ•´æºå¸¦ Ping å¸§ä¸­ä¼ é€’è¿‡æ¥çš„ â€œåº”ç”¨æ•°æ®â€ å­—æ®µã€‚å¦‚æœç»ˆç«¯æ”¶åˆ°ä¸€ä¸ª Ping å¸§ä½†æ˜¯æ²¡æœ‰å‘é€ Pong å¸§æ¥å›åº”ä¹‹å‰çš„ Ping å¸§ï¼Œé‚£ä¹ˆç»ˆç«¯å¯ä»¥é€‰æ‹©ä»…ä¸ºæœ€è¿‘å¤„ç†çš„ Ping å¸§å‘é€ Pong å¸§ã€‚æ­¤å¤–ï¼Œå¯ä»¥è‡ªåŠ¨å‘é€ä¸€ä¸ª Pong å¸§ï¼Œè¿™ç”¨ä½œå•å‘å¿ƒè·³ã€‚</li>
</ul>
<h4 id="4-4-Socket-æ˜¯ä»€ä¹ˆ"><a href="#4-4-Socket-æ˜¯ä»€ä¹ˆ" class="headerlink" title="4.4 Socket æ˜¯ä»€ä¹ˆ"></a>4.4 Socket æ˜¯ä»€ä¹ˆ</h4><p>ç½‘ç»œä¸Šçš„ä¸¤ä¸ªç¨‹åºé€šè¿‡ä¸€ä¸ªåŒå‘çš„é€šä¿¡è¿æ¥å®ç°æ•°æ®çš„äº¤æ¢ï¼Œè¿™ä¸ªè¿æ¥çš„ä¸€ç«¯ç§°ä¸ºä¸€ä¸ª socketï¼ˆå¥—æ¥å­—ï¼‰ï¼Œå› æ­¤å»ºç«‹ç½‘ç»œé€šä¿¡è¿æ¥è‡³å°‘è¦ä¸€å¯¹ç«¯å£å·ã€‚<strong>socket æœ¬è´¨æ˜¯å¯¹ TCP/IP åè®®æ ˆçš„å°è£…ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªé’ˆå¯¹ TCP æˆ–è€… UDP ç¼–ç¨‹çš„æ¥å£ï¼Œå¹¶ä¸æ˜¯å¦ä¸€ç§åè®®</strong>ã€‚é€šè¿‡ socketï¼Œä½ å¯ä»¥ä½¿ç”¨ TCP/IP åè®®ã€‚</p>
<blockquote>
<p>Socket çš„è‹±æ–‡åŸä¹‰æ˜¯â€œå­”â€æˆ–â€œæ’åº§â€ã€‚ä½œä¸º BSD UNIX çš„<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1">è¿›ç¨‹é€šä¿¡</a>æœºåˆ¶ï¼Œå–åä¸€ç§æ„æ€ã€‚é€šå¸¸ä¹Ÿç§°ä½œâ€<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%A5%97%E6%8E%A5%E5%AD%97">å¥—æ¥å­—</a>â€œï¼Œç”¨äºæè¿°IPåœ°å€å’Œç«¯å£ï¼Œæ˜¯ä¸€ä¸ªé€šä¿¡é“¾çš„å¥æŸ„ï¼Œå¯ä»¥ç”¨æ¥å®ç°ä¸åŒè™šæ‹Ÿæœºæˆ–ä¸åŒè®¡ç®—æœºä¹‹é—´çš„é€šä¿¡ã€‚</p>
<p>åœ¨Internet ä¸Šçš„<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%B8%BB%E6%9C%BA">ä¸»æœº</a>ä¸€èˆ¬è¿è¡Œäº†å¤šä¸ªæœåŠ¡è½¯ä»¶ï¼ŒåŒæ—¶æä¾›å‡ ç§æœåŠ¡ã€‚æ¯ç§æœåŠ¡éƒ½æ‰“å¼€ä¸€ä¸ªSocketï¼Œå¹¶ç»‘å®šåˆ°ä¸€ä¸ªç«¯å£ä¸Šï¼Œä¸åŒçš„ç«¯å£å¯¹åº”äºä¸åŒçš„æœåŠ¡ã€‚Socket æ­£å¦‚å…¶è‹±æ–‡åŸä¹‰é‚£æ ·ï¼Œåƒä¸€ä¸ªå¤šå­”æ’åº§ã€‚ä¸€å°ä¸»æœºçŠ¹å¦‚å¸ƒæ»¡å„ç§æ’åº§çš„æˆ¿é—´ï¼Œæ¯ä¸ªæ’åº§æœ‰ä¸€ä¸ªç¼–å·ï¼Œæœ‰çš„æ’åº§æä¾› 220 ä¼äº¤æµç”µï¼Œ æœ‰çš„æä¾› 110 ä¼äº¤æµç”µï¼Œæœ‰çš„åˆ™æä¾›æœ‰çº¿ç”µè§†èŠ‚ç›®ã€‚ å®¢æˆ·è½¯ä»¶å°†æ’å¤´æ’åˆ°ä¸åŒç¼–å·çš„æ’åº§ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸åŒçš„æœåŠ¡ã€‚â€”â€” <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/socket/281150">ç™¾åº¦ç™¾ç§‘</a></p>
</blockquote>
<p>å…³äº Socketï¼Œå¯ä»¥æ€»ç»“ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>å®ƒå¯ä»¥å®ç°åº•å±‚é€šä¿¡ï¼Œå‡ ä¹æ‰€æœ‰çš„åº”ç”¨å±‚éƒ½æ˜¯é€šè¿‡ socket è¿›è¡Œé€šä¿¡çš„ã€‚</li>
<li>å¯¹ TCP/IP åè®®è¿›è¡Œå°è£…ï¼Œä¾¿äºåº”ç”¨å±‚åè®®è°ƒç”¨ï¼Œå±äºäºŒè€…ä¹‹é—´çš„ä¸­é—´æŠ½è±¡å±‚ã€‚</li>
<li>TCP/IP åè®®æ—ä¸­ï¼Œä¼ è¾“å±‚å­˜åœ¨ä¸¤ç§é€šç”¨åè®®: TCPã€UDPï¼Œä¸¤ç§åè®®ä¸åŒï¼Œå› ä¸ºä¸åŒå‚æ•°çš„ socket å®ç°è¿‡ç¨‹ä¹Ÿä¸ä¸€æ ·ã€‚</li>
</ul>
<p>ä¸‹å›¾è¯´æ˜äº†é¢å‘è¿æ¥çš„åè®®çš„å¥—æ¥å­— API çš„å®¢æˆ·ç«¯/æœåŠ¡å™¨å…³ç³»ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/7/26/17389e7e394ad059?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<h3 id="äº”ã€å‚è€ƒèµ„æº"><a href="#äº”ã€å‚è€ƒèµ„æº" class="headerlink" title="äº”ã€å‚è€ƒèµ„æº"></a>äº”ã€å‚è€ƒèµ„æº</h3><ul>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/WebSocket">ç»´åŸºç™¾ç§‘ - WebSocket</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket">MDN - WebSocket</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Protocol_upgrade_mechanism">MDN - Protocol_upgrade_mechanism</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSockets_API/Writing_WebSocket_servers">MDN - ç¼–å†™ WebSocket æœåŠ¡å™¨</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6455">rfc6455</a></li>
<li>Web æ€§èƒ½æƒå¨æŒ‡å—</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2020/6/22/172dc5bb94585adf?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6854573221241421838">è½¬è‡ª ã€æ˜é‡‘ã€‘é˜¿å®å“¥</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/blog/about" rel="external nofollow noreferrer">delfino</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://simple-delfino.github.io/blog/blog/node/20200728002/">https://simple-delfino.github.io/blog/blog/node/20200728002/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="/blog/about" target="_blank">delfino</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/blog/tags/WebSocket/">
                                    <span class="chip bg-color">WebSocket</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/blog/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="/blog/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: auto;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: auto;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">ä½ çš„èµè¯†æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/blog/medias/reward/alipay.jpg" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/blog/medias/reward/wechat.jpg" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/blog/backend/20200728001/">
                    <div class="card-image">
                        
                        
                        <img src="/blog/medias/featureimages/1.jpg" class="responsive-img" alt="å°è£… axios æ‹¦æˆªå™¨å®ç°ç”¨æˆ·æ— æ„Ÿåˆ·æ–° access_token">
                        
                        <span class="card-title">å°è£… axios æ‹¦æˆªå™¨å®ç°ç”¨æˆ·æ— æ„Ÿåˆ·æ–° access_token</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            å‰è¨€æœ€è¿‘åšé¡¹ç›®çš„æ—¶å€™ï¼Œæ¶‰åŠåˆ°ä¸€ä¸ªå•ç‚¹ç™»å½•ï¼Œå³æ˜¯é¡¹ç›®çš„ç™»å½•é¡µé¢ï¼Œç”¨çš„æ˜¯å…¬å¸å…±ç”¨çš„ä¸€ä¸ªç™»å½•é¡µé¢ï¼Œåœ¨è¯¥é¡µé¢ç»Ÿä¸€å¤„ç†é€»è¾‘ã€‚æœ€ç»ˆå®ç°ç”¨æˆ·åªéœ€ç™»å½•ä¸€æ¬¡ï¼Œå°±å¯ä»¥ä»¥ç™»å½•çŠ¶æ€è®¿é—®å…¬å¸æ——ä¸‹çš„æ‰€æœ‰ç½‘ç«™ã€‚

â
å•ç‚¹ç™»å½•( Single Sign On ï¼Œç®€ç§° S
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-07-28
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/blog/categories/backend/" class="post-category">
                                    backend
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/blog/tags/axios/">
                        <span class="chip bg-color">axios</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/blog/web/20200725001/">
                    <div class="card-image">
                        
                        
                        <img src="/blog/medias/featureimages/19.jpg" class="responsive-img" alt="ä»Šå¤©è°ˆè°ˆä½œç”¨åŸŸå’Œä½œç”¨åŸŸé“¾">
                        
                        <span class="card-title">ä»Šå¤©è°ˆè°ˆä½œç”¨åŸŸå’Œä½œç”¨åŸŸé“¾</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
JavaScript ä¸­æœ‰ä¸€ä¸ªè¢«ç§°ä¸ºä½œç”¨åŸŸ(Scope)çš„ç‰¹æ€§ã€‚è™½ç„¶å¯¹äºè®¸å¤šæ–°æ‰‹å¼€å‘è€…æ¥è¯´ï¼Œä½œç”¨åŸŸçš„æ¦‚å¿µå¹¶ä¸æ˜¯å¾ˆå®¹æ˜“ç†è§£ï¼Œæœ¬æ–‡æˆ‘ä¼šå°½æˆ‘æ‰€èƒ½ç”¨æœ€ç®€å•çš„æ–¹å¼æ¥è§£é‡Šä½œç”¨åŸŸå’Œä½œç”¨åŸŸé“¾ï¼Œå¸Œæœ›å¤§å®¶æœ‰æ‰€æ”¶è·ï¼

å‰è¨€JavaScript ä¸­æœ‰ä¸€ä¸ªè¢«ç§°ä¸º
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-07-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/blog/categories/web/" class="post-category">
                                    web
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/blog/tags/interview/">
                        <span class="chip bg-color">interview</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'æ¥æº: delfino<br />'
            + 'æ–‡ç« ä½œè€…: delfino<br />'
            + 'æ–‡ç« é“¾æ¥: <a href="' + url + '">' + url + '</a><br />'
            + 'æœ¬æ–‡ç« è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·æ³¨æ˜å‡ºå¤„ã€‚';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script>


<!-- ä»£ç å—æŠ˜è¡Œ -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/blog/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/blog/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/blog/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="/blog/about" target="_blank">delfino</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;ç«™ç‚¹æ€»å­—æ•°:&nbsp;<span
                class="white-color">59.2k</span>&nbsp;å­—
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;æ€»è®¿é—®é‡:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;æ¬¡
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;æ€»è®¿é—®äººæ•°:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;äºº
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/simple-delfino" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1319879149@qq.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1319879149" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 1319879149" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/blog/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/blog/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/blog/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/blog/libs/materialize/materialize.min.js"></script>
    <script src="/blog/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/blog/libs/aos/aos.js"></script>
    <script src="/blog/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/blog/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/blog/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/blog/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/blog/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/blog/libs/background/ribbon.min.js" async="async"></script>
    

    
    <script type="text/javascript" src="/blog/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/blog/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
